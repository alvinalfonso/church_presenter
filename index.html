<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Church Presenter Pro + Cloud</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Merriweather:ital,wght@0,300;0,400;0,700;1,400&display=swap" rel="stylesheet">
    
    <!-- Tailwind Config for Fonts -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                        serif: ['Merriweather', 'serif'],
                    },
                },
            },
        }
    </script>
    
    <style>
        body { margin: 0; padding: 0; overflow: hidden; background-color: #111827; }
        /* Scrollbar styling */
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: #1f2937; }
        ::-webkit-scrollbar-thumb { background: #374151; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #4b5563; }
        
        .hidden-tab { display: none !important; }
        .loader { border: 3px solid #f3f3f3; border-top: 3px solid #3498db; border-radius: 50%; width: 20px; height: 20px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body>
    <div id="root"></div>

    <!-- React and Dependencies via ESM -->
    <script type="module">
        import React, { useState, useEffect, useRef, useMemo } from 'https://esm.sh/react@18.2.0';
        import ReactDOM from 'https://esm.sh/react-dom@18.2.0/client';
        import { 
            BookOpen, Music, Monitor, Type, Settings, Search, Plus, Save, 
            Trash2, Play, Maximize2, Minimize2, Edit3, X, ChevronRight, 
            ChevronLeft, Loader2, Command, ExternalLink, Power, Globe, Wand2, 
            FolderInput, FileText, Database, Download, List, Image as ImageIcon,
            ArrowUp, ArrowDown, LogIn, LogOut, Upload, Cloud, Archive, Share2,
            FilePlus, Copy
        } from 'https://esm.sh/lucide-react@0.292.0';
        
        // Firebase Imports
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js';
        import { 
            getAuth, signInWithPopup, GoogleAuthProvider, signOut, onAuthStateChanged 
        } from 'https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js';
        // Firestore (Used for Program/Themes)
        import { 
            getFirestore, collection, addDoc, query, onSnapshot, deleteDoc, 
            doc, updateDoc, orderBy, serverTimestamp, writeBatch, where, getDocs 
        } from 'https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js';
        // Storage (Used for Images)
        import { 
            getStorage, ref, uploadBytes, getDownloadURL 
        } from 'https://www.gstatic.com/firebasejs/11.6.1/firebase-storage.js';
        // Realtime Database (Added as requested)
        import { 
            getDatabase, ref as rtdbRef, set, onValue, push, child, update, get 
        } from 'https://www.gstatic.com/firebasejs/11.6.1/firebase-database.js';

        // --- Firebase Configuration ---
        const firebaseConfig = {
            apiKey: "AIzaSyDRxI0hMeaJ4gPCAqMIkN-D4OCiMGPJMWE",
            authDomain: "church-presenter-5e63a.firebaseapp.com",
            databaseURL: "https://church-presenter-5e63a-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "church-presenter-5e63a",
            storageBucket: "church-presenter-5e63a.firebasestorage.app",
            messagingSenderId: "181932302386",
            appId: "1:181932302386:web:48edafd7b55602cf62dc2b",
            measurementId: "G-EVG793JB40"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const storage = getStorage(app);
        const rtdb = getDatabase(app); // Realtime Database Initialized

        // --- Constants ---
        const BIBLE_VERSIONS = [
            { id: 'web', name: 'World English Bible (WEB)' },
            { id: 'kjv', name: 'King James Version (KJV)' },
            // Removed 'tlab' from online list as api doesn't support it reliably. 
            // It will be handled via Local Import.
        ];

        const BIBLE_BOOKS = [
            "Genesis", "Exodus", "Leviticus", "Numbers", "Deuteronomy", "Joshua", "Judges", "Ruth", 
            "1 Samuel", "2 Samuel", "1 Kings", "2 Kings", "1 Chronicles", "2 Chronicles", "Ezra", 
            "Nehemiah", "Esther", "Job", "Psalms", "Proverbs", "Ecclesiastes", "Song of Solomon", 
            "Isaiah", "Jeremiah", "Lamentations", "Ezekiel", "Daniel", "Hosea", "Joel", "Amos", 
            "Obadiah", "Jonah", "Micah", "Nahum", "Habakkuk", "Zephaniah", "Haggai", "Zechariah", 
            "Malachi", "Matthew", "Mark", "Luke", "John", "Acts", "Romans", "1 Corinthians", 
            "2 Corinthians", "Galatians", "Ephesians", "Philippians", "Colossians", "1 Thessalonians", 
            "2 Thessalonians", "1 Timothy", "2 Timothy", "Titus", "Philemon", "Hebrews", "James", 
            "1 Peter", "2 Peter", "1 John", "2 John", "3 John", "Jude", "Revelation"
        ];

        // --- IndexedDB Helpers (Local Songs & Bibles) ---
        const DB_NAME = 'ChurchPresenterDB';
        const initDB = () => {
            return new Promise((resolve, reject) => {
                const request = indexedDB.open(DB_NAME, 2);
                request.onupgradeneeded = (event) => {
                    const db = event.target.result;
                    if (!db.objectStoreNames.contains('local_bibles')) db.createObjectStore('local_bibles', { keyPath: 'id' });
                    if (!db.objectStoreNames.contains('songs')) db.createObjectStore('songs', { keyPath: 'id' });
                };
                request.onsuccess = () => resolve(request.result);
                request.onerror = () => reject(request.error);
            });
        };

        const saveLocalBible = async (bibleData) => {
            const db = await initDB();
            return new Promise((resolve, reject) => {
                const tx = db.transaction('local_bibles', 'readwrite');
                tx.objectStore('local_bibles').put(bibleData);
                tx.oncomplete = () => resolve();
                tx.onerror = () => reject();
            });
        };
        const getLocalBibles = async () => {
            const db = await initDB();
            return new Promise((resolve, reject) => {
                const tx = db.transaction('local_bibles', 'readonly');
                const req = tx.objectStore('local_bibles').getAll();
                req.onsuccess = () => resolve(req.result);
                req.onerror = () => reject();
            });
        };
        const deleteLocalBibleFromDB = async (id) => {
            const db = await initDB();
            return new Promise((resolve, reject) => {
                const tx = db.transaction('local_bibles', 'readwrite');
                tx.objectStore('local_bibles').delete(id);
                tx.oncomplete = () => resolve();
                tx.onerror = () => reject();
            });
        };

        const saveSongToDB = async (song) => {
            const db = await initDB();
            return new Promise((resolve, reject) => {
                const tx = db.transaction('songs', 'readwrite');
                tx.objectStore('songs').put(song);
                tx.oncomplete = () => resolve(song);
                tx.onerror = () => reject(tx.error);
            });
        };
        const getSongsFromDB = async () => {
            const db = await initDB();
            return new Promise((resolve, reject) => {
                const tx = db.transaction('songs', 'readonly');
                const req = tx.objectStore('songs').getAll();
                req.onsuccess = () => resolve(req.result);
                req.onerror = () => reject(req.error);
            });
        };
        const deleteSongFromDB = async (id) => {
            const db = await initDB();
            return new Promise((resolve, reject) => {
                const tx = db.transaction('songs', 'readwrite');
                tx.objectStore('songs').delete(id);
                tx.oncomplete = () => resolve();
                tx.onerror = () => reject(tx.error);
            });
        };


        // --- Projector Window ---
        const PROJECTOR_HTML_TEMPLATE = `
            <!DOCTYPE html>
            <html lang="en">
            <head>
                <meta charset="UTF-8">
                <title>Projector Output</title>
                <script src="https://cdn.tailwindcss.com"><\/script>
                <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700&family=Merriweather:wght@400;700&display=swap" rel="stylesheet">
                <style>
                    body { margin: 0; padding: 0; overflow: hidden; background-color: black; height: 100vh; width: 100vw; display: flex; justify-content: center; align-items: center; background-size: cover; background-position: center; transition: background-image 0.5s ease-in-out; }
                    #slide-container { width: 100%; height: 100%; display: flex; flex-direction: column; align-items: center; justify-content: center; text-align: center; padding: 4rem; text-shadow: 2px 2px 4px rgba(0,0,0,0.8); }
                    .fade-in { animation: fadeIn 0.5s ease-out forwards; }
                    @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
                </style>
            </head>
            <body><div id="slide-container"></div></body>
            </html>
        `;

        // --- Internal Overlay ---
        const InternalOverlay = ({ content, onClose, fontSize, theme, bgImage }) => {
            if (!content) return null;
            const style = { backgroundImage: bgImage ? `url(${bgImage})` : 'none', backgroundSize: 'cover', backgroundPosition: 'center' };
            const getThemeClasses = () => {
                if (bgImage) return 'text-white bg-black/50';
                switch(theme) {
                    case 'white': return 'bg-white text-black';
                    case 'blue': return 'bg-blue-900 text-white';
                    case 'black': default: return 'bg-black text-white';
                }
            };
            return React.createElement('div', { 
                className: `fixed inset-0 z-50 flex flex-col items-center justify-center p-8 transition-colors duration-300 ${!bgImage ? getThemeClasses() : 'text-white'}`,
                style: style
            }, [
                bgImage && React.createElement('div', { className: "absolute inset-0 bg-black/40 z-[-1]" }),
                React.createElement('button', { key: 'close-btn', onClick: onClose, className: "absolute top-4 right-4 p-2 bg-gray-800/50 rounded-full hover:bg-gray-700/50 text-white transition-all opacity-0 hover:opacity-100 z-50" }, React.createElement(Minimize2, { size: 24 })),
                React.createElement('div', { key: 'content-container', className: "max-w-6xl w-full text-center space-y-8 animate-in fade-in duration-500 drop-shadow-lg" }, [
                    content.type === 'bible' && React.createElement(React.Fragment, null, [
                        React.createElement('h1', { className: "font-serif leading-tight whitespace-pre-wrap", style: { fontSize: `${fontSize}px` } }, content.text),
                        React.createElement('div', { className: "text-4xl opacity-90 font-sans mt-8 uppercase tracking-widest border-t border-current pt-4 inline-block" }, [ content.reference, React.createElement('span', { className: "text-sm align-top opacity-50 ml-2" }, content.version) ])
                    ]),
                    content.type === 'song' && React.createElement('div', { className: "flex flex-col h-full justify-center" }, [
                        React.createElement('h1', { className: "font-sans font-bold leading-tight whitespace-pre-wrap", style: { fontSize: `${fontSize}px` } }, content.text),
                        content.title && React.createElement('div', { className: "fixed bottom-8 right-8 text-xl opacity-60 font-sans" }, content.title)
                    ]),
                    content.type === 'custom' && React.createElement('h1', { className: "font-sans font-bold leading-tight whitespace-pre-wrap", style: { fontSize: `${fontSize}px` } }, content.text)
                ]),
                React.createElement('div', { className: "absolute bottom-4 left-1/2 transform -translate-x-1/2 text-white/20 text-xs font-mono" }, "Press ESC to close")
            ]);
        };

        function App() {
            const [user, setUser] = useState(null);
            const [activeTab, setActiveTab] = useState('bible'); 
            const [internalLiveMode, setInternalLiveMode] = useState(false);
            const [liveContent, setLiveContent] = useState(null);
            
            // Settings
            const [fontSize, setFontSize] = useState(60);
            const [theme, setTheme] = useState('black');
            const [backgroundImage, setBackgroundImage] = useState(null);
            const [themeCategory, setThemeCategory] = useState('Worship');
            const [uploadedThemes, setUploadedThemes] = useState({}); // { Category: [ {url, name} ] }
            const [uploadingTheme, setUploadingTheme] = useState(false);

            // Program
            const [program, setProgram] = useState([]);
            const [savedPrograms, setSavedPrograms] = useState([]);
            const [programName, setProgramName] = useState('');
            const [currentProgramId, setCurrentProgramId] = useState(null); // Track active program ID
            const [isSavingProgram, setIsSavingProgram] = useState(false);

            // Bible
            const [bibleBook, setBibleBook] = useState('John');
            const [bibleChapter, setBibleChapter] = useState('3');
            const [bibleVerse, setBibleVerse] = useState('16');
            const [bibleVersion, setBibleVersion] = useState('web');
            const [biblePreview, setBiblePreview] = useState(null);
            const [loadingBible, setLoadingBible] = useState(false);
            const [localBibles, setLocalBibles] = useState([]);

            // Song
            const [songs, setSongs] = useState([]);
            const [songSearch, setSongSearch] = useState('');
            const [songFilter, setSongFilter] = useState('All'); 
            const [selectedSong, setSelectedSong] = useState(null);
            const [isEditingSong, setIsEditingSong] = useState(false);
            const [newSongTitle, setNewSongTitle] = useState('');
            const [newSongArtist, setNewSongArtist] = useState('');
            const [newSongCategory, setNewSongCategory] = useState('Normal');
            const [newSongLyrics, setNewSongLyrics] = useState('');
            const [isFetchingLyrics, setIsFetchingLyrics] = useState(false);
            const [fetchStatus, setFetchStatus] = useState('');
            const [customText, setCustomText] = useState('');
            const [importStatus, setImportStatus] = useState('');
            const projectorWindowRef = useRef(null);

            // --- Authentication ---
            const handleLogin = async () => {
                try {
                    const provider = new GoogleAuthProvider();
                    await signInWithPopup(auth, provider);
                } catch (e) { alert("Login failed: " + e.message); }
            };
            const handleLogout = () => signOut(auth);

            useEffect(() => {
                const unsubscribe = onAuthStateChanged(auth, (currentUser) => {
                    setUser(currentUser);
                    if (currentUser) {
                        // Load saved programs (Firestore)
                        const programsRef = collection(db, 'users', currentUser.uid, 'programs');
                        const q = query(programsRef, orderBy('createdAt', 'desc'));
                        onSnapshot(q, (snap) => {
                            setSavedPrograms(snap.docs.map(d => ({id: d.id, ...d.data()})));
                        });

                        // Load saved themes (Firestore)
                        const themesRef = collection(db, 'users', currentUser.uid, 'themes');
                        const qThemes = query(themesRef, orderBy('createdAt', 'desc'));
                        onSnapshot(qThemes, (snap) => {
                            const themes = {};
                            snap.docs.forEach(doc => {
                                const data = doc.data();
                                const cat = data.category || "General";
                                if (!themes[cat]) themes[cat] = [];
                                themes[cat].push({ id: doc.id, ...data });
                            });
                            setUploadedThemes(themes);
                        }, (error) => {
                            console.error("Error listening to themes:", error);
                        });
                    } else {
                        setSavedPrograms([]);
                        setUploadedThemes({});
                    }
                });
                refreshLocalBibles();
                refreshLocalSongs();
                return () => unsubscribe();
            }, []);

            // --- Window Management ---
            const openProjectorWindow = () => {
                if (projectorWindowRef.current && !projectorWindowRef.current.closed) {
                    projectorWindowRef.current.focus(); return;
                }
                const win = window.open('', 'ChurchPresenterProjector', 'width=1920,height=1080,menubar=no,toolbar=no,location=no,status=no');
                if (win) {
                    win.document.write(PROJECTOR_HTML_TEMPLATE);
                    win.document.close();
                    projectorWindowRef.current = win;
                    updateProjector(liveContent);
                } else { alert("Pop-up blocked!"); }
            };

            const updateProjector = (content) => {
                const win = projectorWindowRef.current;
                if (!win || win.closed) return;
                const doc = win.document;
                const container = doc.getElementById('slide-container');
                const body = doc.body;
                if (!container) return; 

                if (backgroundImage) {
                    body.style.backgroundImage = `url(${backgroundImage})`;
                    body.style.backgroundColor = 'black';
                    container.style.color = 'white';
                } else {
                    body.style.backgroundImage = 'none';
                    if (theme === 'white') { body.style.backgroundColor = 'white'; container.style.color = 'black'; }
                    else if (theme === 'blue') { body.style.backgroundColor = '#1e3a8a'; container.style.color = 'white'; }
                    else { body.style.backgroundColor = 'black'; container.style.color = 'white'; }
                }

                if (!content) { container.innerHTML = ''; return; }

                let html = '';
                if (content.type === 'bible') {
                    html = `<h1 class="font-serif leading-tight whitespace-pre-wrap fade-in" style="font-size: ${fontSize}px">${content.text}</h1><div class="text-4xl opacity-75 font-sans mt-8 uppercase tracking-widest border-t border-current pt-4 inline-block fade-in">${content.reference} <span class="text-sm align-top opacity-50 ml-2">${content.version}</span></div>`;
                } else if (content.type === 'song') {
                    html = `<h1 class="font-sans font-bold leading-tight whitespace-pre-wrap fade-in" style="font-size: ${fontSize}px">${content.text}</h1>${content.title ? `<div class="fixed bottom-8 right-8 text-xl opacity-40 font-sans fade-in">${content.title}</div>` : ''}`;
                } else if (content.type === 'custom') {
                    html = `<h1 class="font-sans font-bold leading-tight whitespace-pre-wrap fade-in" style="font-size: ${fontSize}px">${content.text}</h1>`;
                }
                container.innerHTML = html;
            };

            useEffect(() => { updateProjector(liveContent); }, [liveContent, fontSize, theme, backgroundImage]);

            // --- Theme Functions ---
            const handleCloudThemeUpload = async (e) => {
                if (!user) { alert("Please login to upload themes to cloud."); e.target.value = ''; return; }
                const file = e.target.files[0];
                if (!file) return;

                const category = themeCategory.trim() || "General";
                
                setUploadingTheme(true);
                try {
                    // Upload to Firebase Storage
                    // Use a unique name to prevent overwrites or browser caching issues
                    const storagePath = `themes/${user.uid}/${category}/${Date.now()}_${file.name}`;
                    const storageRef = ref(storage, storagePath);
                    
                    console.log("Starting upload to:", storagePath);
                    await uploadBytes(storageRef, file);
                    console.log("Upload complete, getting URL...");
                    const url = await getDownloadURL(storageRef);
                    console.log("Got URL:", url);

                    // Save reference to Firestore
                    await addDoc(collection(db, 'users', user.uid, 'themes'), {
                        url: url,
                        name: file.name,
                        category: category,
                        createdAt: serverTimestamp()
                    });
                    console.log("Saved to Firestore");
                    
                    setBackgroundImage(url); // Auto set as current
                    alert("Theme uploaded successfully!");
                } catch (err) {
                    console.error("Upload failed detail:", err);
                    let msg = err.message;
                    if (msg.includes("unauthorized") || msg.includes("permission-denied")) msg = "Permission denied. Check Firebase Storage Rules.";
                    else if (msg.includes("cors")) msg = "CORS error. Please configure CORS on your Firebase Storage bucket.";
                    alert("Upload failed: " + msg);
                } finally {
                    setUploadingTheme(false);
                    e.target.value = ''; // Reset input to allow selecting same file again
                }
            };

            // --- Program Functions ---
            const saveProgram = async (saveAsNew = false) => {
                if (!user) { alert("Please login to save programs."); return; }
                
                let name = programName;
                // It's an update if we have an ID and we aren't explicitly forcing "Save As"
                let isUpdate = !!currentProgramId && !saveAsNew;

                if (!isUpdate) {
                    // Prompt for a name if it's new (or Save As)
                    name = prompt("Enter a name for this program:", programName || "Service " + new Date().toLocaleDateString());
                    if (!name) return;
                }

                setIsSavingProgram(true);
                try {
                    if (isUpdate) {
                        // Update existing doc
                        await updateDoc(doc(db, 'users', user.uid, 'programs', currentProgramId), {
                            name: name,
                            items: program,
                            updatedAt: serverTimestamp()
                        });
                        alert(`Program "${name}" updated!`);
                    } else {
                        // Create new doc
                        const docRef = await addDoc(collection(db, 'users', user.uid, 'programs'), {
                            name: name,
                            items: program,
                            createdAt: serverTimestamp()
                        });
                        setCurrentProgramId(docRef.id);
                        setProgramName(name);
                        alert(`Program "${name}" saved as new!`);
                    }
                } catch (e) { alert("Save failed: " + e.message); }
                setIsSavingProgram(false);
            };

            const loadProgram = (prog) => {
                if(confirm(`Load program "${prog.name}"? Current unsaved items will be lost.`)) {
                    setProgram(prog.items);
                    setProgramName(prog.name);
                    setCurrentProgramId(prog.id);
                }
            };
            
            const clearProgram = () => {
                if(program.length > 0 && !confirm("Start a new program? Current list will be cleared.")) return;
                setProgram([]);
                setProgramName('');
                setCurrentProgramId(null);
            };
            
            const deleteProgram = async (id, e) => {
                e.stopPropagation();
                if(!confirm("Delete this program permanently?")) return;
                await deleteDoc(doc(db, 'users', user.uid, 'programs', id));
                if (currentProgramId === id) {
                    setCurrentProgramId(null);
                    setProgramName('');
                }
            };

            const addToProgram = (item) => {
                setProgram(prev => [...prev, { id: Date.now(), ...item }]);
                alert("Added to Program!");
            };

            const moveProgramItem = (index, direction) => {
                const newProg = [...program];
                if (direction === 'up' && index > 0) {
                    [newProg[index], newProg[index-1]] = [newProg[index-1], newProg[index]];
                    setProgram(newProg);
                } else if (direction === 'down' && index < program.length - 1) {
                    [newProg[index], newProg[index+1]] = [newProg[index+1], newProg[index]];
                    setProgram(newProg);
                }
            };
            
            const exportCurrentProgram = () => {
                if (program.length === 0) { alert("Program is empty."); return; }
                const name = programName || "Service_Program";
                const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify({ name, items: program }));
                const downloadAnchorNode = document.createElement('a');
                downloadAnchorNode.setAttribute("href", dataStr);
                downloadAnchorNode.setAttribute("download", `${name}.json`);
                document.body.appendChild(downloadAnchorNode);
                downloadAnchorNode.click();
                downloadAnchorNode.remove();
            };

            const importProgram = (e) => {
                const file = e.target.files[0];
                if (!file) return;
                const reader = new FileReader();
                reader.onload = (event) => {
                    try {
                        const data = JSON.parse(event.target.result);
                        let items = [];
                        let name = "";
                        if (Array.isArray(data)) {
                            items = data;
                        } else if (data.items && Array.isArray(data.items)) {
                            items = data.items;
                            name = data.name || "";
                        } else {
                            throw new Error("Invalid program format");
                        }

                        if (confirm(`Import program${name ? ` "${name}"` : ""}? Current items will be replaced.`)) {
                            setProgram(items);
                            setProgramName(name);
                            setCurrentProgramId(null); // Imported file is "new" until saved
                        }
                    } catch (err) { alert("Import failed: " + err.message); }
                    e.target.value = ''; // Reset input
                };
                reader.readAsText(file);
            };

            // --- Bible Functions ---
            const refreshLocalBibles = () => {
                getLocalBibles().then(bibles => setLocalBibles(bibles)).catch(e => console.log("IDB Error", e));
            }

            const handleVerseNav = (direction) => {
                let nextV = parseInt(bibleVerse);
                if (direction === 'next') nextV++;
                else nextV = Math.max(1, nextV - 1);
                
                setBibleVerse(nextV);
                fetchVerse(bibleBook, bibleChapter, nextV);
            };

            const fetchVerse = async (book = bibleBook, chapter = bibleChapter, verse = bibleVerse) => {
                setLoadingBible(true);
                
                // Tagalog Guard
                if (bibleVersion === 'tlab' || bibleVersion === 'tagalog') {
                    const localExists = localBibles.find(b => b.name.toLowerCase().includes('tagalog') || b.id === 'tlab');
                    if (!localExists) {
                        setBiblePreview({ 
                            type: 'bible', 
                            text: "Online API does not support Tagalog.\n\nPlease import the Tagalog (Ang Biblia) XML file using the import button below.", 
                            reference: "System Message", 
                            version: "Info" 
                        });
                        setLoadingBible(false);
                        return;
                    }
                }

                // Check Local
                const localBible = localBibles.find(b => b.id === bibleVersion);
                if (localBible) {
                    let bookKey = Object.keys(localBible.books).find(b => b.toLowerCase() === book.toLowerCase());
                    if (!bookKey) bookKey = Object.keys(localBible.books).find(b => b.toLowerCase().includes(book.toLowerCase()));

                    if (bookKey && localBible.books[bookKey][chapter] && localBible.books[bookKey][chapter][verse]) {
                         setBiblePreview({
                            type: 'bible',
                            text: localBible.books[bookKey][chapter][verse],
                            reference: `${bookKey} ${chapter}:${verse}`,
                            version: localBible.name,
                            desc: `Bible: ${bookKey} ${chapter}:${verse}`
                        });
                        setLoadingBible(false);
                        return;
                    }
                }

                // API Fallback
                try {
                    const query = `${book}+${chapter}:${verse}`;
                    const response = await fetch(`https://bible-api.com/${query}?translation=${bibleVersion}`);
                    const data = await response.json();
                    if (data.text) {
                        setBiblePreview({
                            type: 'bible',
                            text: data.text.trim(),
                            reference: data.reference,
                            version: bibleVersion.toUpperCase(),
                            desc: `Bible: ${data.reference}`
                        });
                    } else {
                        setBiblePreview({ type: 'bible', text: "Verse not found.", reference: "End of Chapter?", version: "" });
                    }
                } catch (err) {
                    setBiblePreview({ type: 'bible', text: "API Error or Network Offline.", reference: "Error", version: "" });
                }
                setLoadingBible(false);
            };

            // --- Song Functions ---
            const refreshLocalSongs = async () => {
                try {
                    const localSongs = await getSongsFromDB();
                    setSongs(localSongs.sort((a, b) => a.title.localeCompare(b.title)));
                } catch (e) { console.error("Error loading local songs", e); }
            }

            const handleSaveSong = async () => {
                if (!newSongTitle.trim() || !newSongLyrics.trim()) return;
                const songId = (selectedSong && isEditingSong) ? selectedSong.id : Date.now().toString();
                const data = { 
                    id: songId, title: newSongTitle, artist: newSongArtist, lyrics: newSongLyrics, category: newSongCategory, updatedAt: new Date().toISOString()
                };
                if (!isEditingSong) data.createdAt = new Date().toISOString();

                await saveSongToDB(data);
                setNewSongTitle(''); setNewSongArtist(''); setNewSongLyrics(''); setSelectedSong(null); setIsEditingSong(false);
                refreshLocalSongs();
                alert("Song saved locally!");
            };

            const fetchLyrics = async () => {
                if (!newSongTitle) return;
                setFetchStatus(''); setIsFetchingLyrics(true);
                if (newSongArtist) {
                    try {
                        const res = await fetch(`https://api.lyrics.ovh/v1/${encodeURIComponent(newSongArtist)}/${encodeURIComponent(newSongTitle)}`);
                        if (res.ok) {
                            const data = await res.json();
                            if (data.lyrics) { setNewSongLyrics(data.lyrics); setFetchStatus('found'); setIsFetchingLyrics(false); return; }
                        }
                    } catch (e) {}
                }
                setFetchStatus('not-found'); setIsFetchingLyrics(false);
                window.open(`https://www.google.com/search?q=${encodeURIComponent(newSongTitle + " " + newSongArtist + " lyrics")}`, '_blank');
            };

            // Songbook Import/Export
            const exportSongbook = () => {
                if (songs.length === 0) { alert("No songs to export."); return; }
                const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(songs));
                const downloadAnchorNode = document.createElement('a');
                downloadAnchorNode.setAttribute("href", dataStr);
                downloadAnchorNode.setAttribute("download", "songbook_backup.json");
                document.body.appendChild(downloadAnchorNode);
                downloadAnchorNode.click();
                downloadAnchorNode.remove();
            };

            const importSongbook = (e) => {
                const file = e.target.files[0];
                if (!file) return;
                const reader = new FileReader();
                reader.onload = async (event) => {
                    try {
                        const importedSongs = JSON.parse(event.target.result);
                        if (!Array.isArray(importedSongs)) throw new Error("Invalid format");
                        let count = 0;
                        for (const s of importedSongs) {
                            if (s.title && s.lyrics) {
                                await saveSongToDB(s);
                                count++;
                            }
                        }
                        refreshLocalSongs();
                        alert(`Imported ${count} songs successfully!`);
                    } catch (err) { alert("Import failed: " + err.message); }
                };
                reader.readAsText(file);
            };

            // --- Local Import Helpers ---
            const handleBibleImport = async (e) => {
                const file = e.target.files[0];
                if (!file) return;
                setImportStatus("Parsing XML...");
                const text = await file.text();
                const parser = new DOMParser();
                const xmlDoc = parser.parseFromString(text, "text/xml");
                const bibleName = xmlDoc.querySelector("bibleName")?.textContent || file.name.replace('.xml','');
                const books = {};
                xmlDoc.querySelectorAll("BIBLEBOOK").forEach(b => {
                    const bName = b.getAttribute("bname");
                    if (!bName) return;
                    books[bName] = {};
                    b.querySelectorAll("CHAPTER").forEach(c => {
                        const cNum = c.getAttribute("cnumber");
                        books[bName][cNum] = {};
                        c.querySelectorAll("VERS").forEach(v => {
                            books[bName][cNum][v.getAttribute("vnumber")] = v.textContent;
                        });
                    });
                });
                await saveLocalBible({ id: `local-${Date.now()}`, name: bibleName, books: books, type: 'local' });
                refreshLocalBibles();
                setImportStatus(`Imported ${bibleName}!`);
                setTimeout(() => setImportStatus(''), 3000);
            };
            
            const handleFolderImport = async (e, category) => {
                const files = Array.from(e.target.files);
                if (!files.length) return;
                setImportStatus(`Importing ${files.length} songs...`);
                let count = 0;
                for (const file of files) {
                    if (file.name.endsWith('.txt')) {
                        const text = await file.text();
                        await saveSongToDB({
                            id: Date.now().toString() + Math.random().toString(36).substr(2, 9),
                            title: file.name.replace('.txt', ''),
                            lyrics: text,
                            artist: '',
                            category: category,
                            createdAt: new Date().toISOString()
                        });
                        count++;
                    }
                }
                setImportStatus(`Imported ${count} songs.`);
                refreshLocalSongs();
                setTimeout(() => setImportStatus(''), 3000);
            };

            const projectContent = (content) => { setLiveContent(content); };

            const filteredSongs = useMemo(() => songs.filter(s => s.title.toLowerCase().includes(songSearch.toLowerCase()) && (songFilter === 'All' || s.category?.toLowerCase() === songFilter.toLowerCase())), [songs, songSearch, songFilter]);

            const SidebarButton = ({ icon: Icon, label, tabId }) => React.createElement('button', {
                onClick: () => setActiveTab(tabId),
                className: `flex items-center justify-between w-full p-3 mb-2 rounded-lg transition-colors ${activeTab === tabId ? 'bg-blue-600 text-white shadow-md' : 'text-gray-400 hover:bg-gray-800 hover:text-white'}`
            }, [
                React.createElement('div', { className: "flex items-center" }, [ React.createElement(Icon, { size: 20, className: "mr-3" }), React.createElement('span', { className: "font-medium" }, label) ])
            ]);

            return React.createElement('div', { className: "flex flex-col h-screen bg-gray-900 text-gray-100 font-sans overflow-hidden" }, [
                
                internalLiveMode && liveContent && React.createElement(InternalOverlay, { content: liveContent, onClose: () => setInternalLiveMode(false), fontSize: fontSize, theme: theme, bgImage: backgroundImage }),

                React.createElement('header', { className: "flex items-center justify-between px-6 py-3 bg-gray-950 border-b border-gray-800 shrink-0" }, [
                    React.createElement('div', { className: "flex items-center space-x-3" }, [
                        React.createElement(Monitor, { className: "text-blue-500" }),
                        React.createElement('h1', { className: "text-xl font-bold tracking-tight" }, [ "ChurchPresenter", React.createElement('span', { className: "text-xs font-normal text-gray-500 ml-2" }, "Cloud") ])
                    ]),
                    React.createElement('div', { className: "flex items-center space-x-4" }, [
                        user ? React.createElement('div', { className: "flex items-center space-x-2 text-sm text-gray-400" }, [
                            React.createElement('span', {}, user.email),
                            React.createElement('button', { onClick: handleLogout, className: "p-2 hover:bg-gray-800 rounded-full text-white", title: "Logout" }, React.createElement(LogOut, { size: 16 }))
                        ]) : React.createElement('button', { onClick: handleLogin, className: "flex items-center px-4 py-2 bg-blue-700 text-white rounded-lg hover:bg-blue-600 text-sm font-medium" }, [ React.createElement(LogIn, { size: 16, className: "mr-2" }), "Google Login" ]),
                        React.createElement('div', { className: "h-6 w-px bg-gray-800" }),
                        React.createElement('button', { onClick: openProjectorWindow, className: "flex items-center px-4 py-2 bg-gray-800 text-gray-300 rounded-lg hover:bg-gray-700 border border-gray-700 transition-colors text-sm font-medium" }, [ React.createElement(ExternalLink, { size: 16, className: "mr-2" }), "Projector" ]),
                        React.createElement('button', { onClick: () => { if (!liveContent) { alert("Select content!"); return; } setInternalLiveMode(true); }, className: "flex items-center px-4 py-2 rounded-full font-bold bg-green-600 text-white hover:bg-green-500 text-sm" }, [ React.createElement(Maximize2, { size: 16, className: "mr-2" }), "FullScreen" ])
                    ])
                ]),

                React.createElement('div', { className: "flex flex-1 overflow-hidden" }, [
                    React.createElement('nav', { className: "w-64 bg-[#0f1115] border-r border-gray-800 p-4 flex flex-col shrink-0" }, [
                        React.createElement('div', { className: "space-y-1 mb-8" }, [
                            React.createElement(SidebarButton, { icon: List, label: "Program", tabId: "program" }),
                            React.createElement('div', { className: "my-2 border-b border-gray-800" }),
                            React.createElement(SidebarButton, { icon: BookOpen, label: "Bible", tabId: "bible" }),
                            React.createElement(SidebarButton, { icon: Music, label: "Songbook", tabId: "songs" }),
                            React.createElement(SidebarButton, { icon: Type, label: "Custom", tabId: "custom" }),
                            React.createElement(SidebarButton, { icon: Settings, label: "Settings", tabId: "settings" }),
                        ]),
                        React.createElement('div', { className: "mt-auto" }, [
                            React.createElement('div', { className: "space-y-4 bg-gray-800/50 p-3 rounded-lg" }, [
                                React.createElement('div', {}, [ React.createElement('label', { className: "text-xs text-gray-400 mb-1 block" }, "Font Size"), React.createElement('input', { type: "range", min: "30", max: "120", value: fontSize, onChange: (e) => setFontSize(e.target.value), className: "w-full accent-blue-500 h-1 bg-gray-700 rounded-lg" }) ]),
                                React.createElement('div', {}, [ 
                                    React.createElement('label', { className: "text-xs text-gray-400 mb-1 block" }, "Active Theme"),
                                    React.createElement('div', { className: "flex space-x-2" }, ['black', 'white', 'blue'].map(t => React.createElement('button', { key: t, onClick: () => { setTheme(t); setBackgroundImage(null); }, className: `w-6 h-6 rounded-full border-2 ${theme === t && !backgroundImage ? 'border-blue-500 scale-110' : 'border-transparent opacity-50'}`, style: { backgroundColor: t === 'white' ? 'white' : t === 'blue' ? '#1e3a8a' : 'black' } })))
                                ])
                            ]),
                        ])
                    ]),

                    React.createElement('main', { className: "flex-1 flex overflow-hidden" }, [
                        React.createElement('div', { className: "flex-1 bg-gray-900 p-6 flex flex-col overflow-y-auto min-w-[400px]" }, [
                            
                            // PROGRAM TAB
                            React.createElement('div', { className: activeTab === 'program' ? "space-y-6 max-w-4xl mx-auto w-full animate-in fade-in duration-200" : "hidden-tab" }, [
                                React.createElement('div', { className: "flex justify-between items-center mb-6" }, [
                                    React.createElement('div', {}, [
                                        React.createElement('h2', { className: "text-2xl font-bold" }, programName || "New Program"),
                                        React.createElement('div', { className: "text-xs text-gray-500 mt-1" }, currentProgramId ? "(Editing Saved Program)" : "(Unsaved Draft)")
                                    ]),
                                    React.createElement('div', { className: "flex space-x-2 items-center" }, [
                                        React.createElement('button', { onClick: clearProgram, className: "p-2 bg-gray-800 border border-gray-700 hover:bg-gray-700 rounded text-gray-300 mr-2", title: "New Program (Clear)" }, React.createElement(FilePlus, { size: 18 })),
                                        React.createElement('button', { onClick: exportCurrentProgram, className: "p-2 bg-gray-800 border border-gray-700 hover:bg-gray-700 rounded text-gray-300 mr-2", title: "Export to File" }, React.createElement(Download, { size: 18 })),
                                        React.createElement('label', { className: "p-2 bg-gray-800 border border-gray-700 hover:bg-gray-700 rounded text-gray-300 cursor-pointer mr-2", title: "Import from File" }, [ 
                                            React.createElement(Upload, { size: 18 }),
                                            React.createElement('input', { type: 'file', accept: '.json', className: 'hidden', onChange: importProgram })
                                        ]),
                                        React.createElement('div', { className: "w-px h-8 bg-gray-700 mx-2" }),
                                        
                                        // Save Controls
                                        React.createElement('button', { onClick: () => saveProgram(false), disabled: isSavingProgram, className: "flex items-center px-3 py-2 bg-blue-600 hover:bg-blue-500 rounded text-sm text-white" }, [ 
                                            React.createElement(Save, { size: 16, className: "mr-2" }), 
                                            currentProgramId ? "Update" : "Save" 
                                        ]),
                                        currentProgramId && React.createElement('button', { onClick: () => saveProgram(true), disabled: isSavingProgram, className: "p-2 bg-blue-800 hover:bg-blue-700 rounded text-white ml-1", title: "Save As New Copy" }, React.createElement(Copy, { size: 16 })),
                                        
                                        // Load Saved Dropdown
                                        savedPrograms.length > 0 && React.createElement('div', { className: "relative group ml-2" }, [
                                            React.createElement('button', { className: "flex items-center px-3 py-2 bg-gray-700 hover:bg-gray-600 rounded text-sm text-white" }, [ React.createElement(Archive, { size: 16, className: "mr-2" }), "Load Saved" ]),
                                            React.createElement('div', { className: "absolute right-0 top-10 w-64 bg-gray-800 border border-gray-700 rounded-lg shadow-xl hidden group-hover:block z-20 max-h-96 overflow-y-auto" }, 
                                                savedPrograms.map(p => React.createElement('div', { key: p.id, className: `p-3 hover:bg-gray-700 flex justify-between items-center cursor-pointer border-b border-gray-700 ${currentProgramId === p.id ? 'bg-blue-900/30' : ''}`, onClick: () => loadProgram(p) }, [
                                                    React.createElement('span', { className: "text-sm truncate" }, p.name),
                                                    React.createElement('button', { onClick: (e) => deleteProgram(p.id, e), className: "text-gray-500 hover:text-red-400 ml-2" }, React.createElement(Trash2, { size: 14 }))
                                                ]))
                                            )
                                        ])
                                    ])
                                ]),
                                React.createElement('ul', { className: "space-y-3" }, program.map((item, idx) => 
                                    React.createElement('li', { key: item.id, className: "flex items-center bg-gray-800 p-4 rounded-xl border border-gray-700 hover:border-gray-500 transition-colors group" }, [
                                        React.createElement('div', { className: "flex flex-col space-y-1 mr-4" }, [
                                            React.createElement('button', { onClick: () => moveProgramItem(idx, 'up'), disabled: idx === 0, className: "p-1 hover:bg-gray-700 rounded disabled:opacity-30" }, React.createElement(ArrowUp, { size: 16 })),
                                            React.createElement('button', { onClick: () => moveProgramItem(idx, 'down'), disabled: idx === program.length - 1, className: "p-1 hover:bg-gray-700 rounded disabled:opacity-30" }, React.createElement(ArrowDown, { size: 16 }))
                                        ]),
                                        React.createElement('div', { className: "flex-1 cursor-pointer", onClick: () => projectContent(item) }, [
                                            React.createElement('div', { className: "flex items-center" }, [
                                                React.createElement('span', { className: "px-2 py-0.5 rounded text-[10px] uppercase font-bold mr-3 " + (item.type === 'bible' ? 'bg-yellow-900 text-yellow-200' : item.type === 'song' ? 'bg-blue-900 text-blue-200' : 'bg-purple-900 text-purple-200') }, item.type),
                                                React.createElement('span', { className: "font-medium" }, item.desc || (item.title ? item.title : "Custom Slide"))
                                            ]),
                                            React.createElement('div', { className: "text-sm text-gray-400 mt-1 truncate max-w-xl" }, item.text.substring(0, 100) + "...")
                                        ]),
                                        React.createElement('div', { className: "flex space-x-2" }, [
                                            React.createElement('button', { onClick: () => projectContent(item), className: "px-4 py-2 bg-green-700 hover:bg-green-600 text-white rounded-lg text-sm font-medium flex items-center" }, [ React.createElement(Play, { size: 16, className: "mr-2" }), "Live" ]),
                                            React.createElement('button', { onClick: () => setProgram(p => p.filter((_, i) => i !== idx)), className: "p-2 hover:bg-red-900/30 text-gray-500 hover:text-red-400 rounded-lg" }, React.createElement(X, { size: 20 }))
                                        ])
                                    ])
                                ))
                            ]),

                            // BIBLE TAB
                            React.createElement('div', { className: activeTab === 'bible' ? "space-y-6 max-w-2xl mx-auto w-full animate-in fade-in duration-200" : "hidden-tab" }, [
                                React.createElement('div', { className: "grid grid-cols-2 gap-4" }, [
                                    React.createElement('div', { className: "col-span-2 sm:col-span-1" }, [
                                        React.createElement('label', { className: "block text-sm font-medium text-gray-400 mb-1" }, "Book Search"),
                                        React.createElement('input', { list: "bible-books", value: bibleBook, onChange: (e) => setBibleBook(e.target.value), className: "w-full bg-gray-800 border-gray-700 rounded-lg text-white p-2 outline-none", placeholder: "Type to search..." }),
                                        React.createElement('datalist', { id: "bible-books" }, BIBLE_BOOKS.map(b => React.createElement('option', { key: b, value: b })))
                                    ]),
                                    React.createElement('div', { className: "grid grid-cols-2 gap-2" }, [
                                        React.createElement('div', {}, [ React.createElement('label', { className: "block text-sm font-medium text-gray-400 mb-1" }, "Chapter"), React.createElement('input', { type: "number", value: bibleChapter, onChange: (e) => setBibleChapter(e.target.value), className: "w-full bg-gray-800 border-gray-700 rounded-lg text-white p-2 outline-none" }) ]),
                                        React.createElement('div', {}, [ React.createElement('label', { className: "block text-sm font-medium text-gray-400 mb-1" }, "Verse"), React.createElement('input', { type: "number", value: bibleVerse, onChange: (e) => setBibleVerse(e.target.value), className: "w-full bg-gray-800 border-gray-700 rounded-lg text-white p-2 outline-none" }) ])
                                    ]),
                                    React.createElement('div', { className: "col-span-2" }, [
                                        React.createElement('label', { className: "block text-sm font-medium text-gray-400 mb-1" }, "Translation"),
                                        React.createElement('div', { className: "flex flex-wrap gap-2" }, [
                                            ...BIBLE_VERSIONS.map(v => React.createElement('button', { key: v.id, onClick: () => setBibleVersion(v.id), className: `flex-1 py-2 px-3 text-sm rounded-lg border min-w-[120px] ${bibleVersion === v.id ? 'bg-blue-600 border-blue-600 text-white' : 'bg-gray-800 border-gray-700 text-gray-300 hover:bg-gray-700'}` }, v.name)),
                                            React.createElement('button', { onClick: () => setBibleVersion('tlab'), className: `flex-1 py-2 px-3 text-sm rounded-lg border min-w-[120px] ${bibleVersion === 'tlab' ? 'bg-yellow-600 border-yellow-600 text-white' : 'bg-gray-800 border-gray-700 text-gray-300 hover:bg-gray-700'}` }, "Tagalog (Ang Biblia)"),
                                            ...localBibles.map(v => React.createElement('button', { key: v.id, onClick: () => setBibleVersion(v.id), className: `flex-1 py-2 px-3 text-sm rounded-lg border min-w-[120px] ${bibleVersion === v.id ? 'bg-green-600 border-green-600 text-white' : 'bg-gray-800 border-gray-700 text-gray-300 hover:bg-gray-700'}` }, v.name + " (Local)"))
                                        ])
                                    ])
                                ]),
                                React.createElement('div', { className: "flex space-x-2" }, [
                                    React.createElement('button', { onClick: () => handleVerseNav('prev'), className: "p-3 bg-gray-700 hover:bg-gray-600 rounded-lg text-white" }, React.createElement(ChevronLeft, { size: 24 })),
                                    React.createElement('button', { onClick: () => fetchVerse(), disabled: loadingBible, className: "flex-1 py-3 bg-blue-600 hover:bg-blue-500 text-white rounded-lg font-medium flex justify-center items-center transition-colors" }, loadingBible ? React.createElement(Loader2, { className: "animate-spin mr-2" }) : [React.createElement(Search, { className: "mr-2", size: 18 }), "Find Verse"]),
                                    React.createElement('button', { onClick: () => handleVerseNav('next'), className: "p-3 bg-gray-700 hover:bg-gray-600 rounded-lg text-white" }, React.createElement(ChevronRight, { size: 24 })),
                                ]),
                                biblePreview && React.createElement('div', { className: "bg-gray-800 rounded-xl p-6 border border-gray-700 shadow-xl" }, [
                                    React.createElement('div', { className: "text-sm text-gray-400 mb-2 uppercase tracking-wide flex justify-between" }, [ React.createElement('span', {}, "Preview"), React.createElement('span', {}, biblePreview.version) ]),
                                    React.createElement('p', { className: "text-xl font-serif mb-4 leading-relaxed whitespace-pre-line" }, biblePreview.text),
                                    React.createElement('div', { className: "flex justify-end space-x-3" }, [
                                        React.createElement('button', { onClick: () => addToProgram(biblePreview), className: "flex items-center px-4 py-2 bg-gray-700 text-white rounded-lg hover:bg-gray-600" }, [React.createElement(Plus, { size: 16, className: "mr-2" }), "Add to Program"]),
                                        React.createElement('button', { onClick: () => projectContent(biblePreview), className: "flex items-center px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-500" }, [React.createElement(Monitor, { size: 16, className: "mr-2" }), "Project"])
                                    ])
                                ])
                            ]),

                            // SONGS TAB
                            React.createElement('div', { className: activeTab === 'songs' ? "h-full flex flex-col animate-in fade-in duration-200" : "hidden-tab" }, [
                                React.createElement('div', { className: "flex justify-between items-center mb-4" }, [
                                    React.createElement('div', { className: "flex space-x-2 flex-1 mr-4" }, [
                                        React.createElement('div', { className: "relative flex-1" }, [
                                            React.createElement(Search, { className: "absolute left-3 top-2.5 text-gray-500", size: 18 }),
                                            React.createElement('input', { type: "text", placeholder: "Search songs...", value: songSearch, onChange: (e) => setSongSearch(e.target.value), className: "w-full bg-gray-800 border-gray-700 rounded-lg pl-10 text-white p-2 outline-none" })
                                        ]),
                                        React.createElement('button', { onClick: () => { setSelectedSong(null); setIsEditingSong(true); setNewSongTitle(''); setNewSongArtist(''); setNewSongLyrics(''); }, className: "px-3 bg-gray-700 hover:bg-gray-600 rounded-lg text-white" }, React.createElement(Plus, { size: 20 }))
                                    ]),
                                    React.createElement('div', { className: "flex space-x-2" }, [
                                        React.createElement('button', { onClick: exportSongbook, className: "p-2 text-gray-400 hover:text-white bg-gray-800 rounded-lg border border-gray-700", title: "Backup Songbook" }, React.createElement(Download, { size: 18 })),
                                        React.createElement('label', { className: "p-2 text-gray-400 hover:text-white bg-gray-800 rounded-lg border border-gray-700 cursor-pointer", title: "Restore Songbook" }, [
                                            React.createElement(Upload, { size: 18 }),
                                            React.createElement('input', { type: 'file', accept: '.json', className: 'hidden', onChange: importSongbook })
                                        ])
                                    ])
                                ]),
                                React.createElement('div', { className: "flex-1 flex gap-4 overflow-hidden" }, [
                                    React.createElement('div', { className: "w-1/3 bg-gray-800 rounded-lg border border-gray-700 overflow-y-auto" }, React.createElement('ul', { className: "divide-y divide-gray-700" }, filteredSongs.map(song => React.createElement('li', { key: song.id, onClick: () => { setSelectedSong(song); setIsEditingSong(false); }, className: `p-3 cursor-pointer hover:bg-gray-700 transition-colors ${selectedSong?.id === song.id ? 'bg-blue-900/30 border-l-4 border-blue-500' : ''}` }, [
                                        React.createElement('div', { className: "font-medium truncate" }, song.title),
                                        song.artist && React.createElement('div', { className: "text-xs text-gray-500 truncate" }, song.artist)
                                    ])))),
                                    React.createElement('div', { className: "flex-1 bg-gray-800 rounded-lg border border-gray-700 p-4 flex flex-col overflow-hidden" }, isEditingSong ? React.createElement('div', { className: "flex flex-col h-full space-y-4" }, [
                                        React.createElement('div', { className: "flex space-x-2" }, [
                                            React.createElement('input', { type: "text", placeholder: "Title", value: newSongTitle, onChange: (e) => setNewSongTitle(e.target.value), className: "flex-1 bg-gray-900 border-gray-600 rounded-lg text-white outline-none p-2" }),
                                            React.createElement('button', { onClick: fetchLyrics, disabled: isFetchingLyrics, className: "px-3 bg-gray-700 hover:bg-blue-600 rounded-lg text-white" }, React.createElement(Globe, { size: 18 }))
                                        ]),
                                        React.createElement('input', { type: "text", placeholder: "Artist", value: newSongArtist, onChange: (e) => setNewSongArtist(e.target.value), className: "w-full bg-gray-900 border-gray-600 rounded-lg text-white outline-none p-2" }),
                                        React.createElement('textarea', { placeholder: "Lyrics...", value: newSongLyrics, onChange: (e) => setNewSongLyrics(e.target.value), className: "flex-1 bg-gray-900 border-gray-600 rounded-lg text-white font-mono text-sm p-4 outline-none" }),
                                        React.createElement('div', { className: "flex justify-end space-x-2" }, [ React.createElement('button', { onClick: () => setIsEditingSong(false), className: "px-4 py-2 text-gray-400" }, "Cancel"), React.createElement('button', { onClick: handleSaveSong, className: "flex items-center px-4 py-2 bg-blue-600 rounded-lg text-white" }, [React.createElement(Save, { size: 16, className: "mr-2" }), "Save"]) ])
                                    ]) : selectedSong ? React.createElement('div', { className: "flex flex-col h-full" }, [
                                        React.createElement('div', { className: "flex justify-between items-start mb-4" }, [ 
                                            React.createElement('h2', { className: "text-xl font-bold" }, selectedSong.title),
                                            React.createElement('div', { className: "flex space-x-2" }, [ 
                                                React.createElement('button', { onClick: () => addToProgram({ type: 'song', text: selectedSong.lyrics.split('\n\n')[0] + "...", fullText: selectedSong.lyrics, title: selectedSong.title, desc: "Song: " + selectedSong.title }), className: "p-2 text-gray-400 hover:text-white bg-gray-800 rounded-lg" }, React.createElement(List, { size: 16 })),
                                                React.createElement('button', { onClick: () => { setIsEditingSong(true); setNewSongTitle(selectedSong.title); setNewSongArtist(selectedSong.artist || ''); setNewSongLyrics(selectedSong.lyrics); }, className: "p-2 text-gray-400 hover:text-white" }, React.createElement(Edit3, { size: 16 })), 
                                                React.createElement('button', { onClick: () => { if(confirm('Delete?')) { deleteSongFromDB(selectedSong.id); setSelectedSong(null); refreshLocalSongs(); } }, className: "p-2 text-gray-400 hover:text-red-500" }, React.createElement(Trash2, { size: 16 })) 
                                            ]) 
                                        ]),
                                        React.createElement('div', { className: "flex-1 overflow-y-auto space-y-2" }, selectedSong.lyrics.split('\n\n').map((stanza, idx) => React.createElement('div', { key: idx, className: "group p-3 rounded-lg border border-gray-700 hover:border-gray-500 bg-gray-900/50 cursor-pointer", onClick: () => projectContent({ type: 'song', text: stanza, title: selectedSong.title }) }, [ React.createElement('div', { className: "text-sm whitespace-pre-wrap" }, stanza) ])))
                                    ]) : React.createElement('div', { className: "flex-1 flex items-center justify-center text-gray-500" }, "Select a song"))
                                ])
                            ]),

                            // CUSTOM TAB
                            React.createElement('div', { className: activeTab === 'custom' ? "max-w-2xl mx-auto w-full space-y-6 animate-in fade-in duration-200" : "hidden-tab" }, [
                                React.createElement('div', {}, [ React.createElement('label', { className: "block text-sm font-medium text-gray-400 mb-2" }, "Custom Slide Content"), React.createElement('textarea', { value: customText, onChange: (e) => setCustomText(e.target.value), placeholder: "Type your announcement or message here...", className: "w-full h-64 bg-gray-800 border-gray-700 rounded-lg text-white p-4 text-lg outline-none" }) ]),
                                React.createElement('div', { className: "flex justify-end space-x-3" }, [
                                    React.createElement('button', { onClick: () => addToProgram({ type: 'custom', text: customText }), className: "flex items-center px-6 py-3 bg-gray-700 text-white rounded-lg hover:bg-gray-600" }, [React.createElement(Plus, { size: 18, className: "mr-2" }), "Add to Program"]),
                                    React.createElement('button', { onClick: () => projectContent({ type: 'custom', text: customText }), className: "flex items-center px-6 py-3 bg-blue-600 text-white rounded-lg hover:bg-blue-500" }, [React.createElement(Monitor, { size: 18, className: "mr-2" }), "Project Slide"])
                                ])
                            ]),

                            // SETTINGS TAB
                            React.createElement('div', { className: activeTab === 'settings' ? "max-w-4xl mx-auto w-full space-y-8 animate-in fade-in duration-200" : "hidden-tab" }, [
                                React.createElement('div', { className: "space-y-4" }, [
                                    React.createElement('h2', { className: "text-xl font-bold flex items-center" }, [ React.createElement(ImageIcon, { className: "mr-2" }), "Cloud Theme Manager" ]),
                                    !user ? React.createElement('div', { className: "p-4 bg-yellow-900/30 text-yellow-200 rounded-lg border border-yellow-800" }, "Please login with Google to save and categorize themes.") : 
                                    React.createElement('div', { className: "bg-gray-800 p-6 rounded-lg border border-gray-700" }, [
                                        React.createElement('div', { className: "grid grid-cols-1 md:grid-cols-2 gap-4 mb-6" }, [
                                            React.createElement('div', {}, [
                                                React.createElement('label', { className: "block text-sm font-medium text-gray-400 mb-2" }, "Category"),
                                                React.createElement('input', { type: "text", placeholder: "e.g., Worship, Sermon", value: themeCategory, onChange: (e) => setThemeCategory(e.target.value), className: "w-full bg-gray-900 border-gray-700 rounded-lg p-2 text-white outline-none" })
                                            ]),
                                            React.createElement('div', {}, [
                                                React.createElement('label', { className: "block text-sm font-medium text-gray-400 mb-2" }, "Upload Image (PNG, JPG, GIF)"),
                                                React.createElement('input', { type: "file", accept: "image/png, image/jpeg, image/gif", onChange: handleCloudThemeUpload, disabled: uploadingTheme, className: "block w-full text-sm text-gray-400 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-blue-600 file:text-white hover:file:bg-blue-700" })
                                            ])
                                        ]),
                                        uploadingTheme && React.createElement('div', { className: "text-blue-400 text-sm mb-4" }, "Uploading to Cloud..."),
                                        React.createElement('div', { className: "space-y-4" }, Object.entries(uploadedThemes).map(([cat, themes]) => 
                                            React.createElement('div', { key: cat }, [
                                                React.createElement('h3', { className: "text-sm font-bold text-gray-500 uppercase mb-2" }, cat),
                                                React.createElement('div', { className: "grid grid-cols-2 md:grid-cols-4 gap-4" }, themes.map(t => 
                                                    React.createElement('div', { key: t.id, onClick: () => setBackgroundImage(t.url), className: `cursor-pointer rounded-lg overflow-hidden border-2 h-24 relative group ${backgroundImage === t.url ? 'border-green-500' : 'border-transparent hover:border-blue-500'}` }, [
                                                        React.createElement('img', { src: t.url, className: "w-full h-full object-cover" }),
                                                        React.createElement('div', { className: "absolute bottom-0 left-0 right-0 bg-black/70 text-[10px] p-1 truncate" }, t.name)
                                                    ])
                                                ))
                                            ])
                                        ))
                                    ])
                                ]),

                                React.createElement('div', { className: "h-px bg-gray-800" }),

                                React.createElement('div', { className: "space-y-4" }, [
                                    React.createElement('h2', { className: "text-xl font-bold flex items-center" }, [ React.createElement(FolderInput, { className: "mr-2" }), "Local Imports" ]),
                                    importStatus && React.createElement('div', { className: "p-3 bg-blue-900/30 border border-blue-800 text-blue-200 rounded-lg text-sm animate-pulse" }, importStatus),
                                    React.createElement('div', { className: "grid grid-cols-1 md:grid-cols-2 gap-4" }, [
                                        React.createElement('label', { className: "p-4 bg-gray-800 rounded-lg border border-gray-700 hover:bg-gray-700 cursor-pointer flex flex-col items-center justify-center text-center space-y-2" }, [
                                            React.createElement(Music, { size: 32, className: "text-yellow-500" }),
                                            React.createElement('span', { className: "font-semibold" }, "Batch Import Songs (Folder)"),
                                            React.createElement('input', { type: "file", webkitdirectory: "true", directory: "true", multiple: true, className: "hidden", onChange: (e) => handleFolderImport(e, 'Imported') })
                                        ]),
                                        React.createElement('label', { className: "p-4 bg-gray-800 rounded-lg border border-gray-700 hover:bg-gray-700 cursor-pointer flex flex-col items-center justify-center text-center space-y-2" }, [
                                            React.createElement(FileText, { size: 32, className: "text-blue-500" }),
                                            React.createElement('span', { className: "font-semibold" }, "Import XML Bible (For Tagalog)"),
                                            React.createElement('input', { type: "file", accept: ".xml", className: "hidden", onChange: handleBibleImport })
                                        ]),
                                    ]),
                                    localBibles.length > 0 && React.createElement('div', { className: "mt-4" }, [
                                        React.createElement('h3', { className: "text-sm font-semibold text-gray-500 mb-2 uppercase" }, "Installed Local Bibles"),
                                        React.createElement('ul', { className: "space-y-2" }, localBibles.map(b => 
                                            React.createElement('li', { key: b.id, className: "flex items-center justify-between p-3 bg-gray-800 rounded-lg" }, [
                                                React.createElement('span', { className: "font-medium" }, b.name),
                                                React.createElement('button', { onClick: () => { if(confirm('Delete Bible?')) { deleteLocalBibleFromDB(b.id); refreshLocalBibles(); } }, className: "text-red-400 hover:text-red-300 p-2" }, React.createElement(Trash2, { size: 16 }))
                                            ])
                                        ))
                                    ])
                                ])
                            ])
                        ]),

                        React.createElement('div', { className: "w-80 bg-black border-l border-gray-800 flex flex-col shrink-0" }, [
                            React.createElement('div', { className: "p-3 border-b border-gray-800 bg-gray-900" }, 
                                React.createElement('h3', { className: "text-xs font-bold text-gray-400 uppercase tracking-widest flex items-center" }, [
                                    React.createElement('div', { className: `w-2 h-2 rounded-full mr-2 ${liveContent ? 'bg-red-500 animate-pulse' : 'bg-gray-600'}` }),
                                    "Live Preview"
                                ])
                            ),
                            React.createElement('div', { className: "flex-1 p-4 flex items-center justify-center overflow-hidden relative" }, 
                                React.createElement('div', {
                                    className: "aspect-video w-full bg-white text-black rounded shadow-lg overflow-hidden relative flex flex-col items-center justify-center p-2 text-center select-none",
                                    style: { 
                                        backgroundImage: backgroundImage ? `url(${backgroundImage})` : 'none',
                                        backgroundSize: 'cover',
                                        backgroundPosition: 'center',
                                        backgroundColor: theme === 'blue' ? '#1e3a8a' : theme === 'black' ? '#000' : '#fff', 
                                        color: backgroundImage ? 'white' : (theme === 'white' ? '#000' : '#fff')
                                    }
                                }, liveContent ? [
                                    backgroundImage && React.createElement('div', { className: "absolute inset-0 bg-black/40" }),
                                    React.createElement('div', { style: { fontSize: 'clamp(8px, 2vw, 14px)', whiteSpace: 'pre-wrap', lineHeight: '1.2', zIndex: 10 }, className: "font-bold relative" }, liveContent.text),
                                    liveContent.type === 'bible' && React.createElement('div', { className: "mt-2 text-[8px] opacity-75 border-t border-current pt-1 relative z-10" }, liveContent.reference)
                                ] : React.createElement('div', { className: "text-gray-500 text-xs" }, "OFF AIR (Black)"))
                            ),
                            React.createElement('div', { className: "p-4 bg-gray-900 border-t border-gray-800" }, [
                                React.createElement('button', { onClick: () => setLiveContent(null), className: "w-full p-3 bg-red-900/30 hover:bg-red-900/50 border border-red-800 rounded text-xs text-center text-red-400 font-bold flex items-center justify-center" }, [React.createElement(Power, { size: 14, className: "mr-2" }), "Blackout (ESC)"])
                            ])
                        ])
                    ])
                ])
            ]);
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(React.createElement(App));
    </script>
</body>
</html>
