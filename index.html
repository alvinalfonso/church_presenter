<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Church Presenter Pro + Cloud</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Merriweather:ital,wght@0,300;0,400;0,700;1,400&family=Oswald:wght@400;700&family=Lato:wght@400;700;900&family=Playfair+Display:ital,wght@0,400;0,700;1,400&family=Open+Sans:ital,wght@0,400;0,700;1,400&family=Roboto:ital,wght@0,400;0,700;1,400&display=swap" rel="stylesheet">
    
    <!-- Tailwind Config for Fonts -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                        serif: ['Merriweather', 'serif'],
                        mono: ['monospace'],
                        oswald: ['Oswald', 'sans-serif'],
                        lato: ['Lato', 'sans-serif'],
                        playfair: ['Playfair Display', 'serif'],
                        open: ['Open Sans', 'sans-serif'],
                        roboto: ['Roboto', 'sans-serif'],
                    },
                    cursor: {
                        'move': 'move',
                    }
                },
            },
        }
    </script>
    
    <style>
        body { margin: 0; padding: 0; overflow: hidden; background-color: #111827; }
        /* Scrollbar styling */
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: #1f2937; }
        ::-webkit-scrollbar-thumb { background: #374151; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #4b5563; }
        
        .hidden-tab { display: none !important; }
        .loader { border: 3px solid #f3f3f3; border-top: 3px solid #3498db; border-radius: 50%; width: 20px; height: 20px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        /* Custom Editor Styles */
        .editor-element { position: absolute; user-select: none; box-sizing: border-box; }
        .editor-element:hover { outline: 1px dashed rgba(255,255,255,0.3); }
        .editor-element.selected { outline: 2px dashed #3b82f6; cursor: move; } /* z-index handled inline now */
        .resize-handle {
            position: absolute; bottom: -6px; right: -6px; width: 12px; height: 12px;
            background-color: #3b82f6; border: 2px solid white; border-radius: 50%;
            cursor: nwse-resize; z-index: 100; display: none;
        }
        .editor-element.selected .resize-handle { display: block; }
    </style>
</head>
<body>
    <div id="root"></div>

    <!-- React and Dependencies via ESM -->
    <script type="module">
        import React, { useState, useEffect, useRef, useMemo } from 'https://esm.sh/react@18.2.0';
        import ReactDOM from 'https://esm.sh/react-dom@18.2.0/client';
        import { 
            BookOpen, Music, Monitor, Type, Settings, Search, Plus, Save, 
            Trash2, Play, Maximize2, Minimize2, Edit3, X, ChevronRight, 
            ChevronLeft, Loader2, Command, ExternalLink, Power, Globe, Wand2, 
            FolderInput, FileText, Database, Download, List, Image as ImageIcon,
            ArrowUp, ArrowDown, LogIn, LogOut, Upload, Cloud, Archive, Share2,
            FilePlus, Copy, HardDrive, Move, AlignLeft, AlignCenter, AlignRight,
            Type as TypeIcon, Palette, MousePointer2, Scaling, Layers,
            Bold, Italic, MinusCircle, CheckCircle, WifiOff, Crop,
            ArrowUpFromLine, ArrowDownFromLine, Split
        } from 'https://esm.sh/lucide-react@0.292.0';
        
        // Firebase Imports
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.13.1/firebase-app.js';
        import { 
            getAuth, signInWithPopup, GoogleAuthProvider, signOut, onAuthStateChanged 
        } from 'https://www.gstatic.com/firebasejs/10.13.1/firebase-auth.js';
        import { 
            getFirestore, collection, addDoc, query, onSnapshot, deleteDoc, 
            doc, updateDoc, orderBy, serverTimestamp, writeBatch, where, getDocs, getDoc
        } from 'https://www.gstatic.com/firebasejs/10.13.1/firebase-firestore.js';

        // --- Firebase Configuration ---
        const firebaseConfig = {
            apiKey: "AIzaSyDRxI0hMeaJ4gPCAqMIkN-D4OCiMGPJMWE",
            authDomain: "church-presenter-5e63a.firebaseapp.com",
            databaseURL: "https://church-presenter-5e63a-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "church-presenter-5e63a",
            storageBucket: "church-presenter-5e63a.firebasestorage.app",
            messagingSenderId: "181932302386",
            appId: "1:181932302386:web:48edafd7b55602cf62dc2b",
            measurementId: "G-EVG793JB40"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // --- Constants ---
        const BIBLE_VERSIONS = [
            { id: 'web', name: 'World English Bible (WEB)' },
            { id: 'kjv', name: 'King James Version (KJV)' },
        ];
        
        const FONT_OPTIONS = [
            { id: 'sans', name: 'Inter (Sans)', val: 'Inter, sans-serif' },
            { id: 'serif', name: 'Merriweather (Serif)', val: 'Merriweather, serif' },
            { id: 'oswald', name: 'Oswald (Condensed)', val: 'Oswald, sans-serif' },
            { id: 'lato', name: 'Lato (Round)', val: 'Lato, sans-serif' },
            { id: 'playfair', name: 'Playfair (Display)', val: 'Playfair Display, serif' },
            { id: 'open', name: 'Open Sans', val: '"Open Sans", sans-serif' },
            { id: 'roboto', name: 'Roboto', val: 'Roboto, sans-serif' },
            { id: 'mono', name: 'Monospace', val: 'monospace' },
        ];

        const BIBLE_BOOKS = [
            "Genesis", "Exodus", "Leviticus", "Numbers", "Deuteronomy", "Joshua", "Judges", "Ruth", 
            "1 Samuel", "2 Samuel", "1 Kings", "2 Kings", "1 Chronicles", "2 Chronicles", "Ezra", 
            "Nehemiah", "Esther", "Job", "Psalms", "Proverbs", "Ecclesiastes", "Song of Solomon", 
            "Isaiah", "Jeremiah", "Lamentations", "Ezekiel", "Daniel", "Hosea", "Joel", "Amos", 
            "Obadiah", "Jonah", "Micah", "Nahum", "Habakkuk", "Zephaniah", "Haggai", "Zechariah", 
            "Malachi", "Matthew", "Mark", "Luke", "John", "Acts", "Romans", "1 Corinthians", 
            "2 Corinthians", "Galatians", "Ephesians", "Philippians", "Colossians", "1 Thessalonians", 
            "2 Thessalonians", "1 Timothy", "2 Timothy", "Titus", "Philemon", "Hebrews", "James", 
            "1 Peter", "2 Peter", "1 John", "2 John", "3 John", "Jude", "Revelation"
        ];

        // --- IndexedDB Helpers ---
        const DB_NAME = 'ChurchPresenterDB';
        const DB_VERSION = 4; // Incremented for offline_bibles
        
        const initDB = () => {
            return new Promise((resolve, reject) => {
                const request = indexedDB.open(DB_NAME, DB_VERSION);
                request.onupgradeneeded = (event) => {
                    const db = event.target.result;
                    if (!db.objectStoreNames.contains('songs')) db.createObjectStore('songs', { keyPath: 'id' });
                    if (!db.objectStoreNames.contains('local_themes')) db.createObjectStore('local_themes', { keyPath: 'id' });
                    if (!db.objectStoreNames.contains('offline_bibles')) db.createObjectStore('offline_bibles', { keyPath: 'id' });
                };
                request.onsuccess = () => resolve(request.result);
                request.onerror = () => reject(request.error);
            });
        };

        const saveToDB = async (storeName, data) => {
            const db = await initDB();
            return new Promise((resolve, reject) => {
                const tx = db.transaction(storeName, 'readwrite');
                tx.objectStore(storeName).put(data);
                tx.oncomplete = () => resolve(data);
                tx.onerror = () => reject(tx.error);
            });
        };
        const getFromDB = async (storeName, key) => {
            const db = await initDB();
            return new Promise((resolve, reject) => {
                const tx = db.transaction(storeName, 'readonly');
                const store = tx.objectStore(storeName);
                const req = key ? store.get(key) : store.getAll();
                req.onsuccess = () => resolve(req.result);
                req.onerror = () => reject(req.error);
            });
        };
        const deleteFromDB = async (storeName, id) => {
            const db = await initDB();
            return new Promise((resolve, reject) => {
                const tx = db.transaction(storeName, 'readwrite');
                tx.objectStore(storeName).delete(id);
                tx.oncomplete = () => resolve();
                tx.onerror = () => reject(tx.error);
            });
        };

        const saveSongToDB = (d) => saveToDB('songs', d);
        const getSongsFromDB = () => getFromDB('songs');
        const deleteSongFromDB = (id) => deleteFromDB('songs', id);
        
        const saveThemeToDB = (d) => saveToDB('local_themes', d);
        const getThemesFromDB = () => getFromDB('local_themes');
        const deleteThemeFromDB = (id) => deleteFromDB('local_themes', id);

        const saveBibleToDB = (d) => saveToDB('offline_bibles', d);
        const getBibleFromDB = (id) => getFromDB('offline_bibles', id);
        const getAllOfflineBibles = () => getFromDB('offline_bibles');

        // --- Projector Window ---
        // EDITED: Fixed aspect ratio container (1920x1080) with auto-scaling to ensure exact alignment
        const PROJECTOR_HTML_TEMPLATE = `
            <!DOCTYPE html>
            <html lang="en">
            <head>
                <meta charset="UTF-8">
                <title>Projector Output</title>
                <script src="https://cdn.tailwindcss.com"><\/script>
                <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Merriweather:ital,wght@0,300;0,400;0,700;1,400&family=Oswald:wght@400;700&family=Lato:wght@400;700;900&family=Playfair+Display:ital,wght@0,400;0,700;1,400&family=Open+Sans:ital,wght@0,400;0,700;1,400&family=Roboto:ital,wght@0,400;0,700;1,400&display=swap" rel="stylesheet">
                <style>
                    body { margin: 0; padding: 0; overflow: hidden; background-color: #000; height: 100vh; width: 100vw; display: flex; justify-content: center; align-items: center; }
                    /* Reference 16:9 Canvas (1920x1080) used to ensure strict positional alignment */
                    #slide-view { 
                        width: 1920px; height: 1080px; 
                        position: relative; 
                        background-color: transparent; 
                        background-size: cover; background-position: center; 
                        flex-shrink: 0; 
                        transform-origin: center center; 
                        overflow: hidden;
                    }
                    .center-content { display: flex; flex-direction: column; align-items: center; justify-content: center; text-align: center; height: 100%; width: 100%; padding: 4rem; text-shadow: 2px 2px 4px rgba(0,0,0,0.8); box-sizing: border-box; }
                    .fade-in { animation: fadeIn 0.5s ease-out forwards; }
                    @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
                    .custom-element { position: absolute; white-space: pre-wrap; word-wrap: break-word; }
                </style>
                <script>
                    function fitSlide() {
                        const slide = document.getElementById('slide-view');
                        if(!slide) return;
                        const targetW = 1920, targetH = 1080;
                        const winW = window.innerWidth, winH = window.innerHeight;
                        const scale = Math.min(winW / targetW, winH / targetH);
                        slide.style.transform = 'scale(' + scale + ')';
                    }
                    window.addEventListener('resize', fitSlide);
                    window.addEventListener('DOMContentLoaded', fitSlide);
                <\/script>
            </head>
            <body><div id="slide-view"></div></body>
            </html>
        `;

        // --- Utils ---
        const getFontFamily = (fontId) => {
            const found = FONT_OPTIONS.find(f => f.id === fontId);
            return found ? found.val : 'Inter, sans-serif';
        };

        const getShadow = (outlineColor) => {
            if (!outlineColor || outlineColor === 'none' || outlineColor === 'transparent') return 'none';
            return `-1px -1px 0 ${outlineColor}, 1px -1px 0 ${outlineColor}, -1px 1px 0 ${outlineColor}, 1px 1px 0 ${outlineColor}`;
        };

        // --- Internal Overlay ---
        const InternalOverlay = ({ content, onClose, fontSize, theme, bgImage }) => {
            if (!content) return null;
            const style = { backgroundImage: bgImage ? `url("${bgImage}")` : 'none', backgroundSize: 'cover', backgroundPosition: 'center' };
            const getThemeClasses = () => {
                if (bgImage) return 'text-white bg-black/50';
                switch(theme) {
                    case 'white': return 'bg-white text-black';
                    case 'blue': return 'bg-blue-900 text-white';
                    case 'black': default: return 'bg-black text-white';
                }
            };
            
            return React.createElement('div', { 
                className: `fixed inset-0 z-50 flex flex-col p-0 transition-colors duration-300 ${!bgImage ? getThemeClasses() : 'text-white'}`,
                style: style
            }, [
                bgImage && React.createElement('div', { key: 'bg-overlay', className: "absolute inset-0 bg-black/40 z-[-1]" }),
                React.createElement('button', { key: 'close-btn', onClick: onClose, className: "absolute top-4 right-4 p-2 bg-gray-800/50 rounded-full hover:bg-gray-700/50 text-white transition-all opacity-0 hover:opacity-100 z-50" }, React.createElement(Minimize2, { size: 24 })),
                
                content.type === 'custom' || content.type === 'program_custom'
                ? (content.elements ? 
                    React.createElement('div', { key: 'custom-multi', className: "w-full h-full relative" },
                        [...content.elements].sort((a,b) => (a.zIndex || 0) - (b.zIndex || 0)).map(el => {
                             if (el.type === 'image') {
                                 return React.createElement('img', {
                                    key: el.id,
                                    src: el.src,
                                    className: "custom-element fade-in object-contain",
                                    style: { left: `${el.x}%`, top: `${el.y}%`, width: `${el.w}%`, height: `${el.h}%`, zIndex: el.zIndex || 1 }
                                 });
                             }
                             const s = el.styles;
                             const shadow = getShadow(s.outline);
                             const font = getFontFamily(s.font);
                             return React.createElement('div', {
                                key: el.id,
                                className: "custom-element fade-in",
                                style: {
                                    left: `${el.x}%`, top: `${el.y}%`, width: `${el.w}%`, height: el.h ? `${el.h}%` : 'auto',
                                    color: s.color, textAlign: s.align, fontFamily: font, 
                                    fontWeight: s.bold ? 'bold' : 'normal', fontStyle: s.italic ? 'italic' : 'normal',
                                    fontSize: `${s.fontSize || fontSize}px`, textShadow: shadow,
                                    zIndex: el.zIndex || 1
                                }
                             }, el.text);
                        })
                    )
                    : null
                  )
                : React.createElement('div', { key: 'std-content', className: "w-full h-full flex flex-col items-center justify-center p-8 text-center space-y-8 animate-in fade-in duration-500 drop-shadow-lg" }, [
                    (content.type === 'bible' || content.type === 'program_bible') && React.createElement(React.Fragment, null, [
                        React.createElement('h1', { className: "font-serif leading-tight whitespace-pre-wrap", style: { fontSize: `${fontSize}px` } }, content.text),
                        React.createElement('div', { className: "text-4xl opacity-90 font-sans mt-8 uppercase tracking-widest border-t border-current pt-4 inline-block" }, [ content.reference, React.createElement('span', { className: "text-sm align-top opacity-50 ml-2" }, content.version) ])
                    ]),
                    (content.type === 'song' || content.type === 'program_song_slide') && React.createElement('div', { className: "flex flex-col h-full justify-center" }, [
                        React.createElement('h1', { className: "font-sans font-bold leading-tight whitespace-pre-wrap", style: { fontSize: `${fontSize}px` } }, content.text),
                        content.title && React.createElement('div', { className: "fixed bottom-8 right-8 text-xl opacity-60 font-sans" }, content.title)
                    ])
                ]),
                React.createElement('div', { key: 'footer', className: "absolute bottom-4 left-1/2 transform -translate-x-1/2 text-white/20 text-xs font-mono" }, "Press ESC to close")
            ]);
        };

        function App() {
            const [user, setUser] = useState(null);
            const [activeTab, setActiveTab] = useState('bible'); 
            const [internalLiveMode, setInternalLiveMode] = useState(false);
            const [liveContent, setLiveContent] = useState(null);
            
            // Settings
            const [fontSize, setFontSize] = useState(60);
            const [theme, setTheme] = useState('black');
            const [backgroundImage, setBackgroundImage] = useState(null);
            
            // Theme Manager State
            const [themeCategory, setThemeCategory] = useState('General'); 
            const [isCreatingFolder, setIsCreatingFolder] = useState(false);
            const [newFolderName, setNewFolderName] = useState('');
            const [localThemes, setLocalThemes] = useState({});
            const [uploadingTheme, setUploadingTheme] = useState(false);

            // Program
            const [program, setProgram] = useState([]);
            const [savedPrograms, setSavedPrograms] = useState([]);
            const [programName, setProgramName] = useState('');
            const [currentProgramId, setCurrentProgramId] = useState(null); 
            const [isSavingProgram, setIsSavingProgram] = useState(false);
            const [editingProgramItemIndex, setEditingProgramItemIndex] = useState(null);
            const [tempProgramEditText, setTempProgramEditText] = useState('');

            // Bible
            const [bibleBook, setBibleBook] = useState('John');
            const [bibleChapter, setBibleChapter] = useState('3');
            const [bibleVerse, setBibleVerse] = useState('16');
            const [bibleVersion, setBibleVersion] = useState('web');
            const [biblePreview, setBiblePreview] = useState(null);
            const [loadingBible, setLoadingBible] = useState(false);
            const [cloudBibles, setCloudBibles] = useState([]); 
            const [offlineBibles, setOfflineBibles] = useState({}); 

            // Song
            const [songs, setSongs] = useState([]);
            const [songSearch, setSongSearch] = useState('');
            const [songFilter, setSongFilter] = useState('All'); 
            const [selectedSong, setSelectedSong] = useState(null);
            const [isEditingSong, setIsEditingSong] = useState(false);
            const [newSongTitle, setNewSongTitle] = useState('');
            const [newSongArtist, setNewSongArtist] = useState('');
            const [newSongCategory, setNewSongCategory] = useState('Normal');
            const [newSongLyrics, setNewSongLyrics] = useState('');
            const [isFetchingLyrics, setIsFetchingLyrics] = useState(false);
            const [fetchStatus, setFetchStatus] = useState('');
            
            // Custom Slide (Advanced)
            const [customElements, setCustomElements] = useState([{
                id: Date.now(),
                type: 'text',
                text: "Click to Edit\nDouble click toolbar to format",
                x: 10, y: 30, w: 80, h: 40, zIndex: 1,
                styles: { color: '#ffffff', outline: '#000000', font: 'sans', align: 'center', fontSize: 60, bold: false, italic: false }
            }]);
            const [selectedElementId, setSelectedElementId] = useState(customElements[0].id);
            const [dragMode, setDragMode] = useState(null);
            const [programEditMode, setProgramEditMode] = useState(false);
            const stageRef = useRef(null);

            // Crop Modal State
            const [cropModalData, setCropModalData] = useState(null); // { id, src, x, y, zoom }
            const [cropTransform, setCropTransform] = useState({ x: 0, y: 0, zoom: 1 });
            const cropCanvasRef = useRef(null);
            
            const [importStatus, setImportStatus] = useState('');
            const projectorWindowRef = useRef(null);

            // --- Authentication ---
            const handleLogin = async () => {
                try {
                    const provider = new GoogleAuthProvider();
                    await signInWithPopup(auth, provider);
                } catch (e) { alert("Login failed: " + e.message); }
            };
            const handleLogout = () => signOut(auth);

            useEffect(() => {
                const unsubscribe = onAuthStateChanged(auth, (currentUser) => {
                    setUser(currentUser);
                    if (currentUser) {
                        const programsRef = collection(db, 'users', currentUser.uid, 'programs');
                        const q = query(programsRef, orderBy('createdAt', 'desc'));
                        onSnapshot(q, (snap) => {
                            setSavedPrograms(snap.docs.map(d => ({id: d.id, ...d.data()})));
                        });
                        refreshCloudBibles(); 
                    } else {
                        setSavedPrograms([]);
                        setCloudBibles([]); 
                    }
                });
                refreshLocalSongs();
                refreshLocalThemes();
                refreshOfflineBibles();
                return () => unsubscribe();
            }, []);

            // --- IndexedDB Sync Helpers ---
            const refreshLocalThemes = async () => {
                try {
                    const themes = await getThemesFromDB();
                    const grouped = {};
                    themes.forEach(t => {
                        const cat = t.category || "General";
                        if (!grouped[cat]) grouped[cat] = [];
                        grouped[cat].push(t);
                    });
                    setLocalThemes(grouped);
                } catch (e) { console.error("Error loading themes:", e); }
            };

            const refreshOfflineBibles = async () => {
                try {
                    const bibles = await getAllOfflineBibles();
                    const bMap = {};
                    bibles.forEach(b => bMap[b.id] = true);
                    setOfflineBibles(bMap);
                } catch(e) { console.error("Error refreshing offline bibles", e); }
            };

            const availableFolders = useMemo(() => {
                const folders = Object.keys(localThemes);
                const defaults = ['General', 'Worship', 'Sermon', 'Announcements'];
                return [...new Set([...defaults, ...folders])].sort();
            }, [localThemes]);

            const deleteTheme = async (themeId) => {
                if(!confirm("Are you sure you want to delete this theme from local storage?")) return;
                try {
                    await deleteThemeFromDB(themeId);
                    refreshLocalThemes();
                } catch (e) {
                    alert("Failed to delete theme: " + e.message);
                }
            };

            // --- Window Management ---
            const openProjectorWindow = () => {
                if (projectorWindowRef.current && !projectorWindowRef.current.closed) {
                    projectorWindowRef.current.focus(); return;
                }
                const win = window.open('', 'ChurchPresenterProjector', 'width=1920,height=1080,menubar=no,toolbar=no,location=no,status=no');
                if (win) {
                    win.document.write(PROJECTOR_HTML_TEMPLATE);
                    win.document.close();
                    projectorWindowRef.current = win;
                    // Trigger initial update after a short delay to ensure DOM is ready
                    setTimeout(() => updateProjector(liveContent), 100);
                } else { alert("Pop-up blocked!"); }
            };

            const updateProjector = (content) => {
                const win = projectorWindowRef.current;
                if (!win || win.closed) return;
                const doc = win.document;
                const container = doc.getElementById('slide-view'); // Fixed targeting
                const body = doc.body;
                if (!container) return; 

                // Force scale update
                if (win.fitSlide) win.fitSlide();

                // EDITED: Apply background to container instead of body to match editor aspect ratio crop
                if (backgroundImage) {
                    container.style.backgroundImage = `url("${backgroundImage}")`;
                    container.style.backgroundColor = 'transparent';
                    container.style.color = 'white';
                    body.style.backgroundImage = 'none';
                } else {
                    container.style.backgroundImage = 'none';
                    body.style.backgroundImage = 'none';
                    if (theme === 'white') { container.style.backgroundColor = 'white'; container.style.color = 'black'; }
                    else if (theme === 'blue') { container.style.backgroundColor = '#1e3a8a'; container.style.color = 'white'; }
                    else { container.style.backgroundColor = 'black'; container.style.color = 'white'; }
                }

                if (!content) { container.innerHTML = ''; return; }

                let html = '';
                if (content.type === 'bible' || content.type === 'program_bible') {
                    html = `<div class="center-content"><h1 class="font-serif leading-tight whitespace-pre-wrap fade-in" style="font-size: ${fontSize}px">${content.text}</h1><div class="text-4xl opacity-75 font-sans mt-8 uppercase tracking-widest border-t border-current pt-4 inline-block fade-in">${content.reference} <span class="text-sm align-top opacity-50 ml-2">${content.version}</span></div></div>`;
                } else if (content.type === 'song' || content.type === 'program_song_slide') {
                    html = `<div class="center-content"><h1 class="font-sans font-bold leading-tight whitespace-pre-wrap fade-in" style="font-size: ${fontSize}px">${content.text}</h1>${content.title ? `<div class="fixed bottom-8 right-8 text-xl opacity-40 font-sans fade-in">${content.title}</div>` : ''}</div>`;
                } else if (content.type === 'custom' || content.type === 'program_custom') {
                    if (content.elements) {
                         const sorted = [...content.elements].sort((a,b) => (a.zIndex || 0) - (b.zIndex || 0));
                         html = sorted.map(el => {
                             if(el.type === 'image') {
                                 return `<img src="${el.src}" class="custom-element fade-in" style="left:${el.x}%; top:${el.y}%; width:${el.w}%; height:${el.h}%; z-index:${el.zIndex||1}; object-fit: contain;">`;
                             }
                             const s = el.styles;
                             const shadow = getShadow(s.outline);
                             const font = getFontFamily(s.font);
                             const fw = s.bold ? 'bold' : 'normal';
                             const fs = s.italic ? 'italic' : 'normal';
                             return `<div class="custom-element fade-in" style="left:${el.x}%; top:${el.y}%; width:${el.w}%; color:${s.color}; text-align:${s.align}; font-family:${font}; font-weight:${fw}; font-style:${fs}; font-size:${s.fontSize || fontSize}px; text-shadow:${shadow}; z-index:${el.zIndex||1};">${el.text}</div>`;
                         }).join('');
                    }
                }
                container.innerHTML = html;
            };

            useEffect(() => { updateProjector(liveContent); }, [liveContent, fontSize, theme, backgroundImage]);

            // --- Theme Functions ---
            const handleLocalThemeUpload = async (e) => {
                const file = e.target.files[0];
                if (!file) return;
                let category = themeCategory;
                if (isCreatingFolder) {
                    category = newFolderName.trim();
                    if (!category) { alert("Please enter a folder name."); return; }
                }
                setUploadingTheme(true);
                const reader = new FileReader();
                reader.onload = async (event) => {
                    try {
                        const dataUrl = event.target.result;
                        await saveThemeToDB({
                            id: Date.now().toString(),
                            url: dataUrl,
                            name: file.name,
                            category: category,
                            createdAt: new Date().toISOString()
                        });
                        setBackgroundImage(dataUrl); 
                        if (isCreatingFolder) { setThemeCategory(category); setIsCreatingFolder(false); setNewFolderName(''); }
                        refreshLocalThemes();
                        alert("Theme saved locally!");
                    } catch (err) { alert("Failed to save theme: " + err.message); } 
                    finally { setUploadingTheme(false); e.target.value = ''; }
                };
                reader.readAsDataURL(file);
            };

            // --- Program Functions ---
            const saveProgram = async (saveAsNew = false) => {
                if (!user) { alert("Please login to save programs."); return; }
                let name = programName;
                let isUpdate = !!currentProgramId && !saveAsNew;
                if (!isUpdate) {
                    name = prompt("Enter a name for this program:", programName || "Service " + new Date().toLocaleDateString());
                    if (!name) return;
                }
                setIsSavingProgram(true);
                try {
                    if (isUpdate) {
                        await updateDoc(doc(db, 'users', user.uid, 'programs', currentProgramId), { name: name, items: program, updatedAt: serverTimestamp() });
                        alert(`Program "${name}" updated!`);
                    } else {
                        const docRef = await addDoc(collection(db, 'users', user.uid, 'programs'), { name: name, items: program, createdAt: serverTimestamp() });
                        setCurrentProgramId(docRef.id);
                        setProgramName(name);
                        alert(`Program "${name}" saved as new!`);
                    }
                } catch (e) { alert("Save failed: " + e.message); }
                setIsSavingProgram(false);
            };

            const loadProgram = (prog) => {
                if(confirm(`Load program "${prog.name}"? Current unsaved items will be lost.`)) {
                    setProgram(prog.items); setProgramName(prog.name); setCurrentProgramId(prog.id);
                }
            };
            
            const clearProgram = () => {
                if(program.length > 0 && !confirm("Start a new program? Current list will be cleared.")) return;
                setProgram([]); setProgramName(''); setCurrentProgramId(null);
            };
            
            const deleteProgram = async (id, e) => {
                e.stopPropagation();
                if(!confirm("Delete this program permanently?")) return;
                await deleteDoc(doc(db, 'users', user.uid, 'programs', id));
                if (currentProgramId === id) { setCurrentProgramId(null); setProgramName(''); }
            };

            const addToProgram = (item) => {
                if (item.type === 'song') {
                    // Changed: Add as a group that can be broken down later
                    setProgram(prev => [...prev, {
                        id: Date.now(),
                        type: 'program_song_group',
                        title: item.title,
                        fullText: item.fullText,
                        desc: `Song Group: ${item.title}`
                    }]);
                    alert(`Added "${item.title}" to Program (Group).`);
                } else if (item.type === 'custom') {
                    const clonedElements = JSON.parse(JSON.stringify(item.elements));
                    setProgram(prev => [...prev, { 
                        id: Date.now(), 
                        type: 'program_custom', 
                        elements: clonedElements, 
                        desc: item.desc 
                    }]);
                    alert("Added Custom Slide to Program!");
                } else {
                    setProgram(prev => [...prev, { id: Date.now(), ...item, type: 'program_bible' }]); 
                    alert("Added to Program!");
                }
            };
            
            const breakdownSong = (index) => {
                const item = program[index];
                if (item.type !== 'program_song_group') return;
                const stanzas = item.fullText.split('\n\n').filter(t => t.trim().length > 0);
                const slides = stanzas.map(stanza => ({
                    id: Date.now() + Math.random(),
                    type: 'program_song_slide',
                    text: stanza,
                    title: item.title,
                    desc: `Song: ${item.title} (Slide)`
                }));
                const newProg = [...program];
                newProg.splice(index, 1, ...slides);
                setProgram(newProg);
            };

            const moveProgramItem = (index, direction) => {
                const newProg = [...program];
                if (direction === 'up' && index > 0) {
                    [newProg[index], newProg[index-1]] = [newProg[index-1], newProg[index]];
                    setProgram(newProg);
                } else if (direction === 'down' && index < program.length - 1) {
                    [newProg[index], newProg[index+1]] = [newProg[index+1], newProg[index]];
                    setProgram(newProg);
                }
            };

            const editProgramItem = (index) => {
                const item = program[index];
                if (item.type === 'program_song_slide' || item.type === 'program_bible') {
                    setTempProgramEditText(item.text);
                    setEditingProgramItemIndex(index);
                } else if (item.type === 'program_custom') {
                    // Switch to custom tab to edit
                    setCustomElements(JSON.parse(JSON.stringify(item.elements)));
                    setProgramEditMode(index); 
                    setActiveTab('custom');
                    setSelectedElementId(item.elements[0]?.id);
                }
            };

            const saveProgramSimpleEdit = () => {
                setProgram(prev => {
                    const next = [...prev];
                    next[editingProgramItemIndex].text = tempProgramEditText;
                    return next;
                });
                setEditingProgramItemIndex(null);
            };

            const saveProgramCustomEdit = () => {
                setProgram(prev => {
                    const next = [...prev];
                    next[programEditMode].elements = JSON.parse(JSON.stringify(customElements));
                    return next;
                });
                setProgramEditMode(false);
                alert("Program slide updated!");
            };
            
            const exportCurrentProgram = () => {
                if (program.length === 0) { alert("Program is empty."); return; }
                const name = programName || "Service_Program";
                const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify({ name, items: program }));
                const downloadAnchorNode = document.createElement('a');
                downloadAnchorNode.setAttribute("href", dataStr);
                downloadAnchorNode.setAttribute("download", `${name}.json`);
                document.body.appendChild(downloadAnchorNode);
                downloadAnchorNode.click();
                downloadAnchorNode.remove();
            };

            const importProgram = (e) => {
                const file = e.target.files[0];
                if (!file) return;
                const reader = new FileReader();
                reader.onload = (event) => {
                    try {
                        const data = JSON.parse(event.target.result);
                        let items = [];
                        let name = "";
                        if (Array.isArray(data)) items = data;
                        else if (data.items && Array.isArray(data.items)) { items = data.items; name = data.name || ""; }
                        else throw new Error("Invalid program format");

                        if (confirm(`Import program${name ? ` "${name}"` : ""}? Current items will be replaced.`)) {
                            setProgram(items); setProgramName(name); setCurrentProgramId(null); 
                        }
                    } catch (err) { alert("Import failed: " + err.message); }
                    e.target.value = ''; 
                };
                reader.readAsText(file);
            };

            // --- Cloud/Offline Bible Functions ---
            const refreshCloudBibles = async () => {
                if (!auth.currentUser) return; 
                try {
                    const q = query(collection(db, 'shared_bibles'));
                    const querySnapshot = await getDocs(q);
                    const bibles = querySnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    setCloudBibles(bibles);
                } catch (e) { console.error("Error fetching cloud bibles:", e); }
            }
            
            const handleDownloadBible = async (bibleId, bibleName) => {
                if (offlineBibles[bibleId]) return;
                if (!confirm(`Download "${bibleName}" for offline use?`)) return;
                setLoadingBible(true);
                try {
                    const booksCol = collection(db, 'shared_bibles', bibleId, 'books');
                    const snap = await getDocs(booksCol);
                    const booksData = {};
                    snap.forEach(doc => {
                        booksData[doc.id] = doc.data().content;
                    });
                    
                    await saveBibleToDB({
                        id: bibleId,
                        name: bibleName,
                        books: booksData,
                        downloadedAt: new Date().toISOString()
                    });
                    refreshOfflineBibles();
                    alert(`${bibleName} downloaded!`);
                } catch (e) {
                    alert("Download failed: " + e.message);
                } finally {
                    setLoadingBible(false);
                }
            };

            const handleVerseNav = (direction) => {
                let nextV = parseInt(bibleVerse);
                if (direction === 'next') nextV++;
                else nextV = Math.max(1, nextV - 1);
                setBibleVerse(nextV);
                fetchVerse(bibleBook, bibleChapter, nextV);
            };

            const fetchVerse = async (book = bibleBook, chapter = bibleChapter, verse = bibleVerse) => {
                setLoadingBible(true);
                // 1. Check Offline
                const offlineBible = await getBibleFromDB(bibleVersion);
                if (offlineBible) {
                    const cKey = parseInt(chapter).toString();
                    const vKey = parseInt(verse).toString();
                    if (offlineBible.books && offlineBible.books[book] && offlineBible.books[book][cKey] && offlineBible.books[book][cKey][vKey]) {
                         setBiblePreview({
                            type: 'bible',
                            text: offlineBible.books[book][cKey][vKey],
                            reference: `${book} ${cKey}:${vKey}`,
                            version: offlineBible.name + " (Offline)",
                            desc: `Bible: ${book} ${cKey}:${vKey}`
                        });
                        setLoadingBible(false);
                        return;
                    }
                }
                // 2. Check Cloud
                const cloudBible = cloudBibles.find(b => b.id === bibleVersion);
                if (cloudBible) {
                    try {
                        const bookRef = doc(db, 'shared_bibles', bibleVersion, 'books', book);
                        const bookSnap = await getDoc(bookRef);
                        if (bookSnap.exists()) {
                            const content = bookSnap.data().content;
                            const cKey = parseInt(chapter).toString();
                            const vKey = parseInt(verse).toString();
                            if (content[cKey] && content[cKey][vKey]) {
                                setBiblePreview({
                                    type: 'bible',
                                    text: content[cKey][vKey],
                                    reference: `${book} ${cKey}:${vKey}`,
                                    version: cloudBible.name,
                                    desc: `Bible: ${book} ${cKey}:${vKey}`
                                });
                                setLoadingBible(false);
                                return;
                            }
                        }
                    } catch (e) { console.error(e); }
                }
                // 3. Fallback API
                try {
                    const query = `${book}+${chapter}:${verse}`;
                    const response = await fetch(`https://bible-api.com/${query}?translation=${bibleVersion}`);
                    const data = await response.json();
                    if (data.text) {
                        setBiblePreview({ type: 'bible', text: data.text.trim(), reference: data.reference, version: bibleVersion.toUpperCase(), desc: `Bible: ${data.reference}` });
                    } else {
                        setBiblePreview({ type: 'bible', text: "Verse not found.", reference: "End of Chapter?", version: "" });
                    }
                } catch (err) {
                    setBiblePreview({ type: 'bible', text: "API Error or Network Offline.", reference: "Error", version: "" });
                }
                setLoadingBible(false);
            };

            // --- Song Functions ---
            const refreshLocalSongs = async () => {
                try {
                    const localSongs = await getSongsFromDB();
                    setSongs(localSongs.sort((a, b) => a.title.localeCompare(b.title)));
                } catch (e) { console.error("Error loading local songs", e); }
            }

            const handleSaveSong = async () => {
                if (!newSongTitle.trim() || !newSongLyrics.trim()) return;
                const songId = (selectedSong && isEditingSong) ? selectedSong.id : Date.now().toString();
                const data = { id: songId, title: newSongTitle, artist: newSongArtist, lyrics: newSongLyrics, category: newSongCategory, updatedAt: new Date().toISOString() };
                if (!isEditingSong) data.createdAt = new Date().toISOString();
                await saveSongToDB(data);
                setNewSongTitle(''); setNewSongArtist(''); setNewSongLyrics(''); setSelectedSong(null); setIsEditingSong(false);
                refreshLocalSongs();
                alert("Song saved locally!");
            };

            const fetchLyrics = async () => {
                if (!newSongTitle) return;
                setFetchStatus(''); setIsFetchingLyrics(true);
                if (newSongArtist) {
                    try {
                        const res = await fetch(`https://api.lyrics.ovh/v1/${encodeURIComponent(newSongArtist)}/${encodeURIComponent(newSongTitle)}`);
                        if (res.ok) {
                            const data = await res.json();
                            if (data.lyrics) { setNewSongLyrics(data.lyrics); setFetchStatus('found'); setIsFetchingLyrics(false); return; }
                        }
                    } catch (e) {}
                }
                setFetchStatus('not-found'); setIsFetchingLyrics(false);
                window.open(`https://www.google.com/search?q=${encodeURIComponent(newSongTitle + " " + newSongArtist + " lyrics")}`, '_blank');
            };

            const exportSongbook = () => {
                if (songs.length === 0) { alert("No songs to export."); return; }
                const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(songs));
                const downloadAnchorNode = document.createElement('a');
                downloadAnchorNode.setAttribute("href", dataStr);
                downloadAnchorNode.setAttribute("download", "songbook_backup.json");
                document.body.appendChild(downloadAnchorNode);
                downloadAnchorNode.click();
                downloadAnchorNode.remove();
            };

            const importSongbook = (e) => {
                const file = e.target.files[0];
                if (!file) return;
                const reader = new FileReader();
                reader.onload = async (event) => {
                    try {
                        const importedSongs = JSON.parse(event.target.result);
                        if (!Array.isArray(importedSongs)) throw new Error("Invalid format");
                        let count = 0;
                        for (const s of importedSongs) {
                            if (s.title && s.lyrics) { await saveSongToDB(s); count++; }
                        }
                        refreshLocalSongs();
                        alert(`Imported ${count} songs successfully!`);
                    } catch (err) { alert("Import failed: " + err.message); }
                };
                reader.readAsText(file);
            };

            // --- Advanced Custom Slide Functions ---
            const addCustomText = () => {
                const newEl = {
                    id: Date.now(),
                    type: 'text',
                    text: "New Text Box",
                    x: 10, y: 10, w: 30, h: 20, zIndex: customElements.length + 1,
                    styles: { color: '#ffffff', outline: '#000000', font: 'sans', align: 'left', fontSize: 60, bold: false, italic: false }
                };
                setCustomElements(prev => [...prev, newEl]);
                setSelectedElementId(newEl.id);
            };

            const addCustomImage = (e) => {
                const file = e.target.files[0];
                if (!file) return;
                const reader = new FileReader();
                reader.onload = (evt) => {
                    const newEl = {
                        id: Date.now(),
                        type: 'image',
                        src: evt.target.result,
                        x: 20, y: 20, w: 40, h: 40, zIndex: customElements.length + 1
                    };
                    setCustomElements(prev => [...prev, newEl]);
                    setSelectedElementId(newEl.id);
                };
                reader.readAsDataURL(file);
                e.target.value = '';
            };

            const deleteSelectedElement = () => {
                if (customElements.length <= 1) { alert("Slide must have at least one element."); return; }
                setCustomElements(prev => prev.filter(el => el.id !== selectedElementId));
                setSelectedElementId(customElements[0].id); // Select first fallback
            };

            const updateSelectedElement = (updates) => {
                setCustomElements(prev => prev.map(el => el.id === selectedElementId ? { ...el, ...updates } : el));
            };

            const updateSelectedStyle = (styleKey, value) => {
                setCustomElements(prev => prev.map(el => el.id === selectedElementId ? { ...el, styles: { ...el.styles, [styleKey]: value } } : el));
            };
            
            const changeLayer = (action) => {
                if(!selectedElement) return;
                let newZ = selectedElement.zIndex || 1;
                const maxZ = Math.max(...customElements.map(e => e.zIndex || 1));
                const minZ = Math.min(...customElements.map(e => e.zIndex || 1));
                
                if (action === 'up') newZ += 1;
                else if (action === 'down') newZ = Math.max(0, newZ - 1);
                else if (action === 'front') newZ = maxZ + 1;
                else if (action === 'back') newZ = Math.max(0, minZ - 1);

                updateSelectedElement({ zIndex: newZ });
            };

            // Drag and Resize Handlers
            const handleStageMouseDown = (e, elId, type) => {
                e.stopPropagation();
                setSelectedElementId(elId);
                setDragMode(type);
                const el = customElements.find(e => e.id === elId);
                stageRef.current.dragStart = { 
                    mx: e.clientX, my: e.clientY, 
                    elX: el.x, elY: el.y, elW: el.w, elH: el.h 
                };
            };

            const handleStageMouseMove = (e) => {
                if (!dragMode || !stageRef.current) return;
                const { mx, my, elX, elY, elW, elH } = stageRef.current.dragStart;
                const stageRect = stageRef.current.getBoundingClientRect();
                const dx = ((e.clientX - mx) / stageRect.width) * 100;
                const dy = ((e.clientY - my) / stageRect.height) * 100;

                if (dragMode === 'move') {
                    updateSelectedElement({ x: elX + dx, y: elY + dy });
                } else if (dragMode === 'resize') {
                    updateSelectedElement({ w: Math.max(5, elW + dx), h: Math.max(5, elH + dy) });
                }
            };

            const handleStageMouseUp = () => setDragMode(null);
            
            useEffect(() => {
                if (dragMode) {
                    window.addEventListener('mousemove', handleStageMouseMove);
                    window.addEventListener('mouseup', handleStageMouseUp);
                } else {
                    window.removeEventListener('mousemove', handleStageMouseMove);
                    window.removeEventListener('mouseup', handleStageMouseUp);
                }
                return () => {
                    window.removeEventListener('mousemove', handleStageMouseMove);
                    window.removeEventListener('mouseup', handleStageMouseUp);
                };
            }, [dragMode, customElements]);

            const selectedElement = customElements.find(el => el.id === selectedElementId) || customElements[0];

            // --- Image Crop Logic ---
            const openCropModal = () => {
                if(selectedElement.type !== 'image') return;
                setCropModalData({ id: selectedElement.id, src: selectedElement.src });
                setCropTransform({ x: 0, y: 0, zoom: 1 });
            };

            const performCrop = () => {
                // Render the cropped view to canvas and export
                const canvas = document.createElement('canvas');
                // Use a fixed reasonable resolution or original image logic. 
                // For this simple implementation, we'll create a 1280x720 canvas (16:9) representing the frame
                // and draw the zoomed/panned image onto it.
                canvas.width = 1280;
                canvas.height = 720;
                const ctx = canvas.getContext('2d');
                
                const img = new Image();
                img.src = cropModalData.src;
                img.onload = () => {
                    // Calculation: The 'frame' is the canvas. The image is drawn with transform.
                    // Transform origin is center.
                    const { x, y, zoom } = cropTransform;
                    
                    // Center of canvas
                    const cx = canvas.width / 2;
                    const cy = canvas.height / 2;
                    
                    // Draw params
                    // Image acts as 'cover' initially. 
                    const scaleFactor = Math.max(canvas.width / img.width, canvas.height / img.height) * zoom;
                    const drawW = img.width * scaleFactor;
                    const drawH = img.height * scaleFactor;
                    const drawX = cx - (drawW / 2) + x * 5; // Sensitivity adj
                    const drawY = cy - (drawH / 2) + y * 5;

                    ctx.drawImage(img, drawX, drawY, drawW, drawH);
                    
                    const newSrc = canvas.toDataURL('image/png');
                    setCustomElements(prev => prev.map(el => el.id === cropModalData.id ? { ...el, src: newSrc } : el));
                    setCropModalData(null);
                };
            };


            // --- Imports Logic ---
            const handleBibleImportToCloud = async (e) => {
                if (!user) { alert("Please login to upload shared bibles."); return; }
                const file = e.target.files[0];
                if (!file) return;
                setImportStatus("Parsing XML for Cloud (Batching)...");
                try {
                    const text = await file.text();
                    const parser = new DOMParser();
                    const xmlDoc = parser.parseFromString(text, "text/xml");
                    if (xmlDoc.querySelector("parsererror")) throw new Error("Invalid XML file.");
                    let bibleName = "Unknown Bible";
                    const bibleTag = xmlDoc.querySelector("bible");
                    if (bibleTag && bibleTag.getAttribute("translation")) bibleName = bibleTag.getAttribute("translation");
                    else {
                        const titleNode = xmlDoc.querySelector("bibleName, BIBLENAME, title, TITLE");
                        if (titleNode) bibleName = titleNode.textContent;
                        else bibleName = file.name.replace('.xml','');
                    }
                    const books = {};
                    const allBooks = xmlDoc.querySelectorAll("book, BOOK, BIBLEBOOK, biblebook");
                    allBooks.forEach(b => {
                        let bName = b.getAttribute("bname") || b.getAttribute("name") || b.getAttribute("id");
                        const bNumRaw = b.getAttribute("number") || b.getAttribute("n") || b.getAttribute("bnumber");
                        const bNum = parseInt(bNumRaw);
                        if (!bName && !isNaN(bNum) && bNum > 0 && bNum <= 66) bName = BIBLE_BOOKS[bNum - 1];
                        if (bName) {
                            books[bName] = {};
                            const chapters = b.querySelectorAll("chapter, CHAPTER, c, C");
                            chapters.forEach(c => {
                                const cNumRaw = c.getAttribute("number") || c.getAttribute("n") || c.getAttribute("cnumber");
                                if (cNumRaw) {
                                    const cNum = parseInt(cNumRaw).toString();
                                    books[bName][cNum] = {};
                                    const verses = c.querySelectorAll("verse, VERSE, v, V");
                                    verses.forEach(v => {
                                        const vNumRaw = v.getAttribute("number") || v.getAttribute("n") || v.getAttribute("vnumber");
                                        if (vNumRaw) books[bName][cNum][parseInt(vNumRaw).toString()] = v.textContent;
                                    });
                                }
                            });
                        }
                    });
                    if (Object.keys(books).length === 0) throw new Error("No recognized books found.");
                    const bibleRef = await addDoc(collection(db, 'shared_bibles'), { name: bibleName, uploadedBy: user.email, uploadedAt: serverTimestamp() });
                    const batch = writeBatch(db);
                    for (const [bName, bContent] of Object.entries(books)) {
                        const bookRef = doc(db, 'shared_bibles', bibleRef.id, 'books', bName);
                        batch.set(bookRef, { content: bContent });
                    }
                    await batch.commit();
                    refreshCloudBibles();
                    setImportStatus(`Uploaded ${bibleName} to Cloud!`);
                    alert(`Uploaded ${bibleName} to Cloud Library.`);
                } catch (err) { console.error(err); alert("Import failed: " + err.message); setImportStatus("Import failed."); }
                setTimeout(() => setImportStatus(''), 3000);
                e.target.value = ''; 
            };
            
            const handleFolderImport = async (e, category) => {
                const files = Array.from(e.target.files);
                if (!files.length) return;
                setImportStatus(`Importing ${files.length} songs...`);
                let count = 0;
                for (const file of files) {
                    if (file.name.endsWith('.txt')) {
                        const text = await file.text();
                        await saveSongToDB({
                            id: Date.now().toString() + Math.random().toString(36).substr(2, 9),
                            title: file.name.replace('.txt', ''),
                            lyrics: text,
                            artist: '',
                            category: category,
                            createdAt: new Date().toISOString()
                        });
                        count++;
                    }
                }
                setImportStatus(`Imported ${count} songs.`);
                refreshLocalSongs();
                setTimeout(() => setImportStatus(''), 3000);
            };

            const projectContent = (content) => { setLiveContent(content); };

            const filteredSongs = useMemo(() => songs.filter(s => s.title.toLowerCase().includes(songSearch.toLowerCase()) && (songFilter === 'All' || s.category?.toLowerCase() === songFilter.toLowerCase())), [songs, songSearch, songFilter]);

            const SidebarButton = ({ icon: Icon, label, tabId }) => React.createElement('button', {
                onClick: () => setActiveTab(tabId),
                className: `flex items-center justify-between w-full p-3 mb-2 rounded-lg transition-colors ${activeTab === tabId ? 'bg-blue-600 text-white shadow-md' : 'text-gray-400 hover:bg-gray-800 hover:text-white'}`
            }, [
                React.createElement('div', { className: "flex items-center" }, [ React.createElement(Icon, { size: 20, className: "mr-3" }), React.createElement('span', { className: "font-medium" }, label) ])
            ]);

            return React.createElement('div', { className: "flex flex-col h-screen bg-gray-900 text-gray-100 font-sans overflow-hidden" }, [
                
                internalLiveMode && liveContent && React.createElement(InternalOverlay, { content: liveContent, onClose: () => setInternalLiveMode(false), fontSize: fontSize, theme: theme, bgImage: backgroundImage }),
                
                // Crop Modal
                cropModalData && React.createElement('div', { className: "fixed inset-0 z-[60] bg-black/90 flex flex-col items-center justify-center p-8" }, [
                    React.createElement('div', { className: "w-full max-w-4xl flex-1 relative bg-gray-800 border-2 border-dashed border-gray-600 overflow-hidden flex items-center justify-center" }, 
                        React.createElement('div', { 
                            className: "relative w-[80%] h-[80%] border-4 border-blue-500 shadow-[0_0_0_9999px_rgba(0,0,0,0.8)] pointer-events-none",
                        }, [
                             React.createElement('img', { 
                                src: cropModalData.src, 
                                className: "absolute max-w-none pointer-events-auto cursor-move",
                                style: { 
                                    left: "50%", top: "50%",
                                    transform: `translate(-50%, -50%) translate(${cropTransform.x}px, ${cropTransform.y}px) scale(${cropTransform.zoom})`
                                },
                                onMouseDown: (e) => {
                                    const startX = e.clientX; const startY = e.clientY;
                                    const startTX = cropTransform.x; const startTY = cropTransform.y;
                                    const handleMove = (ev) => setCropTransform(p => ({ ...p, x: startTX + (ev.clientX - startX), y: startTY + (ev.clientY - startY) }));
                                    const handleUp = () => { window.removeEventListener('mousemove', handleMove); window.removeEventListener('mouseup', handleUp); };
                                    window.addEventListener('mousemove', handleMove);
                                    window.addEventListener('mouseup', handleUp);
                                }
                             })
                        ])
                    ),
                    React.createElement('div', { className: "w-full max-w-2xl mt-4 flex items-center space-x-4 bg-gray-800 p-4 rounded-lg" }, [
                        React.createElement('span', { className: "text-sm text-gray-400" }, "Zoom"),
                        React.createElement('input', { type: "range", min: "0.1", max: "5", step: "0.1", value: cropTransform.zoom, onChange: e => setCropTransform(p => ({...p, zoom: parseFloat(e.target.value)})), className: "flex-1" }),
                        React.createElement('button', { onClick: () => setCropModalData(null), className: "px-4 py-2 text-gray-300" }, "Cancel"),
                        React.createElement('button', { onClick: performCrop, className: "px-6 py-2 bg-blue-600 text-white rounded font-bold" }, "Apply Crop")
                    ])
                ]),
                
                // Simple Program Item Editor Overlay
                editingProgramItemIndex !== null && React.createElement('div', { className: "fixed inset-0 z-50 bg-black/80 flex items-center justify-center p-4" }, 
                    React.createElement('div', { className: "bg-gray-800 p-6 rounded-lg w-full max-w-lg border border-gray-700 shadow-2xl" }, [
                        React.createElement('h3', { className: "text-lg font-bold mb-4" }, "Edit Slide Content"),
                        React.createElement('textarea', { 
                            value: tempProgramEditText,
                            onChange: e => setTempProgramEditText(e.target.value),
                            className: "w-full h-48 bg-gray-900 border border-gray-600 rounded p-3 text-white mb-4"
                        }),
                        React.createElement('div', { className: "flex justify-end space-x-2" }, [
                            React.createElement('button', { onClick: () => setEditingProgramItemIndex(null), className: "px-4 py-2 bg-gray-700 rounded text-gray-300" }, "Cancel"),
                            React.createElement('button', { onClick: saveProgramSimpleEdit, className: "px-4 py-2 bg-blue-600 rounded text-white" }, "Save Changes")
                        ])
                    ])
                ),

                React.createElement('header', { className: "flex items-center justify-between px-6 py-3 bg-gray-950 border-b border-gray-800 shrink-0" }, [
                    React.createElement('div', { className: "flex items-center space-x-3" }, [
                        React.createElement(Monitor, { className: "text-blue-500" }),
                        React.createElement('h1', { className: "text-xl font-bold tracking-tight" }, [ "ChurchPresenter", React.createElement('span', { className: "text-xs font-normal text-gray-500 ml-2" }, "Cloud Edition") ])
                    ]),
                    React.createElement('div', { className: "flex items-center space-x-4" }, [
                        user ? React.createElement('div', { className: "flex items-center space-x-2 text-sm text-gray-400" }, [
                            React.createElement('span', {}, user.email),
                            React.createElement('button', { onClick: handleLogout, className: "p-2 hover:bg-gray-800 rounded-full text-white", title: "Logout" }, React.createElement(LogOut, { size: 16 }))
                        ]) : React.createElement('button', { onClick: handleLogin, className: "flex items-center px-4 py-2 bg-blue-700 text-white rounded-lg hover:bg-blue-600 text-sm font-medium" }, [ React.createElement(LogIn, { size: 16, className: "mr-2" }), "Google Login" ]),
                        React.createElement('div', { className: "h-6 w-px bg-gray-800" }),
                        React.createElement('button', { onClick: openProjectorWindow, className: "flex items-center px-4 py-2 bg-gray-800 text-gray-300 rounded-lg hover:bg-gray-700 border border-gray-700 transition-colors text-sm font-medium" }, [ React.createElement(ExternalLink, { size: 16, className: "mr-2" }), "Projector" ]),
                        React.createElement('button', { onClick: () => { if (!liveContent) { alert("Select content!"); return; } setInternalLiveMode(true); }, className: "flex items-center px-4 py-2 rounded-full font-bold bg-green-600 text-white hover:bg-green-500 text-sm" }, [ React.createElement(Maximize2, { size: 16, className: "mr-2" }), "FullScreen" ])
                    ])
                ]),

                React.createElement('div', { className: "flex flex-1 overflow-hidden" }, [
                    React.createElement('nav', { className: "w-64 bg-[#0f1115] border-r border-gray-800 p-4 flex flex-col shrink-0" }, [
                        React.createElement('div', { className: "space-y-1 mb-8" }, [
                            React.createElement(SidebarButton, { icon: List, label: "Program", tabId: "program" }),
                            React.createElement('div', { className: "my-2 border-b border-gray-800" }),
                            React.createElement(SidebarButton, { icon: BookOpen, label: "Bible", tabId: "bible" }),
                            React.createElement(SidebarButton, { icon: Music, label: "Songbook", tabId: "songs" }),
                            React.createElement(SidebarButton, { icon: Type, label: "Custom Slides", tabId: "custom" }),
                            React.createElement(SidebarButton, { icon: Settings, label: "Settings", tabId: "settings" }),
                        ]),
                        React.createElement('div', { className: "mt-auto" }, [
                            React.createElement('div', { className: "space-y-4 bg-gray-800/50 p-3 rounded-lg" }, [
                                React.createElement('div', {}, [ React.createElement('label', { className: "text-xs text-gray-400 mb-1 block" }, "Font Size"), React.createElement('input', { type: "range", min: "30", max: "120", value: fontSize, onChange: (e) => setFontSize(e.target.value), className: "w-full accent-blue-500 h-1 bg-gray-700 rounded-lg" }) ]),
                                React.createElement('div', {}, [ 
                                    React.createElement('label', { className: "text-xs text-gray-400 mb-1 block" }, "Active Theme"),
                                    React.createElement('div', { className: "flex space-x-2" }, ['black', 'white', 'blue'].map(t => React.createElement('button', { key: t, onClick: () => { setTheme(t); setBackgroundImage(null); }, className: `w-6 h-6 rounded-full border-2 ${theme === t && !backgroundImage ? 'border-blue-500 scale-110' : 'border-transparent opacity-50'}`, style: { backgroundColor: t === 'white' ? 'white' : t === 'blue' ? '#1e3a8a' : 'black' } })))
                                ])
                            ]),
                        ])
                    ]),

                    React.createElement('main', { className: "flex-1 flex overflow-hidden" }, [
                        React.createElement('div', { className: "flex-1 bg-gray-900 p-6 flex flex-col overflow-y-auto min-w-[400px]" }, [
                            
                            // PROGRAM TAB
                            React.createElement('div', { className: activeTab === 'program' ? "space-y-6 max-w-4xl mx-auto w-full animate-in fade-in duration-200" : "hidden-tab" }, [
                                React.createElement('div', { className: "flex justify-between items-center mb-6" }, [
                                    React.createElement('div', {}, [
                                        React.createElement('h2', { className: "text-2xl font-bold" }, programName || "New Program"),
                                        React.createElement('div', { className: "text-xs text-gray-500 mt-1" }, currentProgramId ? "(Editing Saved Program)" : "(Unsaved Draft)")
                                    ]),
                                    React.createElement('div', { className: "flex space-x-2 items-center" }, [
                                        React.createElement('button', { onClick: clearProgram, className: "p-2 bg-gray-800 border border-gray-700 hover:bg-gray-700 rounded text-gray-300 mr-2", title: "New Program (Clear)" }, React.createElement(FilePlus, { size: 18 })),
                                        React.createElement('button', { onClick: exportCurrentProgram, className: "p-2 bg-gray-800 border border-gray-700 hover:bg-gray-700 rounded text-gray-300 mr-2", title: "Export to File" }, React.createElement(Download, { size: 18 })),
                                        React.createElement('label', { className: "p-2 bg-gray-800 border border-gray-700 hover:bg-gray-700 rounded text-gray-300 cursor-pointer mr-2", title: "Import from File" }, [ 
                                            React.createElement(Upload, { size: 18 }),
                                            React.createElement('input', { type: 'file', accept: '.json', className: 'hidden', onChange: importProgram })
                                        ]),
                                        React.createElement('div', { className: "w-px h-8 bg-gray-700 mx-2" }),
                                        
                                        React.createElement('button', { onClick: () => saveProgram(false), disabled: isSavingProgram, className: "flex items-center px-3 py-2 bg-blue-600 hover:bg-blue-500 rounded text-sm text-white" }, [ 
                                            React.createElement(Save, { size: 16, className: "mr-2" }), 
                                            currentProgramId ? "Update" : "Save" 
                                        ]),
                                        currentProgramId && React.createElement('button', { onClick: () => saveProgram(true), disabled: isSavingProgram, className: "p-2 bg-blue-800 hover:bg-blue-700 rounded text-white ml-1", title: "Save As New Copy" }, React.createElement(Copy, { size: 16 })),
                                        
                                        savedPrograms.length > 0 && React.createElement('div', { className: "relative group ml-2" }, [
                                            React.createElement('button', { className: "flex items-center px-3 py-2 bg-gray-700 hover:bg-gray-600 rounded text-sm text-white" }, [ React.createElement(Archive, { size: 16, className: "mr-2" }), "Load Saved" ]),
                                            React.createElement('div', { className: "absolute right-0 top-10 w-64 bg-gray-800 border border-gray-700 rounded-lg shadow-xl hidden group-hover:block z-20 max-h-96 overflow-y-auto" }, 
                                                savedPrograms.map(p => React.createElement('div', { key: p.id, className: `p-3 hover:bg-gray-700 flex justify-between items-center cursor-pointer border-b border-gray-700 ${currentProgramId === p.id ? 'bg-blue-900/30' : ''}`, onClick: () => loadProgram(p) }, [
                                                    React.createElement('span', { className: "text-sm truncate" }, p.name),
                                                    React.createElement('button', { onClick: (e) => deleteProgram(p.id, e), className: "text-gray-500 hover:text-red-400 ml-2" }, React.createElement(Trash2, { size: 14 }))
                                                ]))
                                            )
                                        ])
                                    ])
                                ]),
                                React.createElement('ul', { className: "space-y-3" }, program.map((item, idx) => 
                                    React.createElement('li', { key: item.id, className: "flex items-center bg-gray-800 p-4 rounded-xl border border-gray-700 hover:border-gray-500 transition-colors group" }, [
                                        React.createElement('div', { className: "flex flex-col space-y-1 mr-4" }, [
                                            React.createElement('button', { onClick: () => moveProgramItem(idx, 'up'), disabled: idx === 0, className: "p-1 hover:bg-gray-700 rounded disabled:opacity-30" }, React.createElement(ArrowUp, { size: 16 })),
                                            React.createElement('button', { onClick: () => moveProgramItem(idx, 'down'), disabled: idx === program.length - 1, className: "p-1 hover:bg-gray-700 rounded disabled:opacity-30" }, React.createElement(ArrowDown, { size: 16 }))
                                        ]),
                                        React.createElement('div', { className: "flex-1 cursor-pointer", onClick: () => item.type !== 'program_song_group' && projectContent(item) }, [
                                            React.createElement('div', { className: "flex items-center" }, [
                                                React.createElement('span', { className: "px-2 py-0.5 rounded text-[10px] uppercase font-bold mr-3 " + (item.type.includes('bible') ? 'bg-yellow-900 text-yellow-200' : item.type.includes('song') ? 'bg-blue-900 text-blue-200' : 'bg-purple-900 text-purple-200') }, item.type.replace('program_', '').replace('_group','')),
                                                React.createElement('span', { className: "font-medium" }, item.desc || (item.title ? item.title : "Custom Slide"))
                                            ]),
                                            React.createElement('div', { className: "text-sm text-gray-400 mt-1 truncate max-w-xl" }, item.text ? item.text.substring(0, 100) + "..." : (item.elements ? item.elements.map(e => e.type === 'image' ? '[Image]' : e.text).join(' ').substring(0, 100) + "..." : (item.type === 'program_song_group' ? 'Song Group (Click breakdown to expand)' : '')))
                                        ]),
                                        React.createElement('div', { className: "flex space-x-2" }, [
                                            item.type === 'program_song_group' ? 
                                            React.createElement('button', { onClick: () => breakdownSong(idx), className: "px-4 py-2 bg-indigo-700 hover:bg-indigo-600 text-white rounded-lg text-sm font-medium flex items-center" }, [ React.createElement(Split, { size: 16, className: "mr-2" }), "Breakdown" ])
                                            : React.createElement('button', { onClick: () => projectContent(item), className: "px-4 py-2 bg-green-700 hover:bg-green-600 text-white rounded-lg text-sm font-medium flex items-center" }, [ React.createElement(Play, { size: 16, className: "mr-2" }), "Live" ]),
                                            
                                            item.type !== 'program_song_group' && React.createElement('button', { onClick: () => editProgramItem(idx), className: "p-2 bg-gray-700 hover:bg-gray-600 text-white rounded-lg text-sm font-medium", title: "Edit Slide" }, React.createElement(Edit3, { size: 16 })),
                                            React.createElement('button', { onClick: () => setProgram(p => p.filter((_, i) => i !== idx)), className: "p-2 hover:bg-red-900/30 text-gray-500 hover:text-red-400 rounded-lg" }, React.createElement(X, { size: 20 }))
                                        ])
                                    ])
                                ))
                            ]),

                            // BIBLE TAB
                            React.createElement('div', { className: activeTab === 'bible' ? "space-y-6 max-w-2xl mx-auto w-full animate-in fade-in duration-200" : "hidden-tab" }, [
                                React.createElement('div', { className: "grid grid-cols-2 gap-4" }, [
                                    React.createElement('div', { className: "col-span-2 sm:col-span-1" }, [
                                        React.createElement('label', { className: "block text-sm font-medium text-gray-400 mb-1" }, "Select Book"),
                                        React.createElement('select', { value: bibleBook, onChange: (e) => setBibleBook(e.target.value), className: "w-full bg-gray-800 border-gray-700 rounded-lg text-white p-2 outline-none cursor-pointer" }, 
                                            BIBLE_BOOKS.map(b => React.createElement('option', { key: b, value: b }, b))
                                        )
                                    ]),
                                    React.createElement('div', { className: "grid grid-cols-2 gap-2" }, [
                                        React.createElement('div', {}, [ React.createElement('label', { className: "block text-sm font-medium text-gray-400 mb-1" }, "Chapter"), React.createElement('input', { type: "number", value: bibleChapter, onChange: (e) => setBibleChapter(e.target.value), className: "w-full bg-gray-800 border-gray-700 rounded-lg text-white p-2 outline-none" }) ]),
                                        React.createElement('div', {}, [ React.createElement('label', { className: "block text-sm font-medium text-gray-400 mb-1" }, "Verse"), React.createElement('input', { type: "number", value: bibleVerse, onChange: (e) => setBibleVerse(e.target.value), className: "w-full bg-gray-800 border-gray-700 rounded-lg text-white p-2 outline-none" }) ])
                                    ]),
                                    React.createElement('div', { className: "col-span-2" }, [
                                        React.createElement('label', { className: "block text-sm font-medium text-gray-400 mb-1 flex justify-between" }, ["Translation", React.createElement('span', { className: "text-xs text-blue-400"}, "Green = Cloud, Check = Offline")]),
                                        React.createElement('div', { className: "flex flex-wrap gap-2" }, [
                                            ...BIBLE_VERSIONS.map(v => React.createElement('button', { key: v.id, onClick: () => setBibleVersion(v.id), className: `flex-1 py-2 px-3 text-sm rounded-lg border min-w-[120px] ${bibleVersion === v.id ? 'bg-blue-600 border-blue-600 text-white' : 'bg-gray-800 border-gray-700 text-gray-300 hover:bg-gray-700'}` }, v.name)),
                                            ...cloudBibles.map(v => React.createElement('div', { key: v.id, className: "relative flex-1 min-w-[140px]" }, [
                                                React.createElement('button', { onClick: () => setBibleVersion(v.id), className: `w-full h-full py-2 px-3 text-sm rounded-lg border flex items-center justify-center ${bibleVersion === v.id ? 'bg-green-600 border-green-600 text-white' : 'bg-gray-800 border-gray-700 text-gray-300 hover:bg-gray-700'}` }, [ 
                                                    offlineBibles[v.id] ? React.createElement(CheckCircle, { size: 12, className: "inline mr-1 text-green-300" }) : React.createElement(Cloud, { size: 12, className: "inline mr-1" }), 
                                                    v.name 
                                                ]),
                                                !offlineBibles[v.id] && React.createElement('button', { onClick: (e) => { e.stopPropagation(); handleDownloadBible(v.id, v.name); }, className: "absolute -top-2 -right-2 p-1 bg-gray-700 rounded-full hover:bg-gray-600 border border-gray-500 shadow-sm", title: "Download Offline" }, React.createElement(Download, { size: 10 }))
                                            ]))
                                        ])
                                    ])
                                ]),
                                React.createElement('div', { className: "flex space-x-2" }, [
                                    React.createElement('button', { onClick: () => handleVerseNav('prev'), className: "p-3 bg-gray-700 hover:bg-gray-600 rounded-lg text-white" }, React.createElement(ChevronLeft, { size: 24 })),
                                    React.createElement('button', { onClick: () => fetchVerse(), disabled: loadingBible, className: "flex-1 py-3 bg-blue-600 hover:bg-blue-500 text-white rounded-lg font-medium flex justify-center items-center transition-colors" }, loadingBible ? React.createElement(Loader2, { className: "animate-spin mr-2" }) : [React.createElement(Search, { className: "mr-2", size: 18 }), "Find Verse"]),
                                    React.createElement('button', { onClick: () => handleVerseNav('next'), className: "p-3 bg-gray-700 hover:bg-gray-600 rounded-lg text-white" }, React.createElement(ChevronRight, { size: 24 })),
                                ]),
                                biblePreview && React.createElement('div', { className: "bg-gray-800 rounded-xl p-6 border border-gray-700 shadow-xl" }, [
                                    React.createElement('div', { className: "text-sm text-gray-400 mb-2 uppercase tracking-wide flex justify-between" }, [ React.createElement('span', {}, "Preview"), React.createElement('span', {}, biblePreview.version) ]),
                                    React.createElement('p', { className: "text-xl font-serif mb-4 leading-relaxed whitespace-pre-line" }, biblePreview.text),
                                    React.createElement('div', { className: "flex justify-end space-x-3" }, [
                                        React.createElement('button', { onClick: () => addToProgram(biblePreview), className: "flex items-center px-4 py-2 bg-gray-700 text-white rounded-lg hover:bg-gray-600" }, [React.createElement(Plus, { size: 16, className: "mr-2" }), "Add to Program"]),
                                        React.createElement('button', { onClick: () => projectContent(biblePreview), className: "flex items-center px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-500" }, [React.createElement(Monitor, { size: 16, className: "mr-2" }), "Project"])
                                    ])
                                ])
                            ]),

                            // SONGS TAB
                            React.createElement('div', { className: activeTab === 'songs' ? "h-full flex flex-col animate-in fade-in duration-200" : "hidden-tab" }, [
                                React.createElement('div', { className: "flex justify-between items-center mb-4" }, [
                                    React.createElement('div', { className: "flex space-x-2 flex-1 mr-4" }, [
                                        React.createElement('div', { className: "relative flex-1" }, [
                                            React.createElement(Search, { className: "absolute left-3 top-2.5 text-gray-500", size: 18 }),
                                            React.createElement('input', { type: "text", placeholder: "Search songs...", value: songSearch, onChange: (e) => setSongSearch(e.target.value), className: "w-full bg-gray-800 border-gray-700 rounded-lg pl-10 text-white p-2 outline-none" })
                                        ]),
                                        React.createElement('button', { onClick: () => { setSelectedSong(null); setIsEditingSong(true); setNewSongTitle(''); setNewSongArtist(''); setNewSongLyrics(''); }, className: "px-3 bg-gray-700 hover:bg-gray-600 rounded-lg text-white" }, React.createElement(Plus, { size: 20 }))
                                    ]),
                                    React.createElement('div', { className: "flex space-x-2" }, [
                                        React.createElement('button', { onClick: exportSongbook, className: "p-2 text-gray-400 hover:text-white bg-gray-800 rounded-lg border border-gray-700", title: "Backup Songbook" }, React.createElement(Download, { size: 18 })),
                                        React.createElement('label', { className: "p-2 text-gray-400 hover:text-white bg-gray-800 rounded-lg border border-gray-700 cursor-pointer", title: "Restore Songbook" }, [
                                            React.createElement(Upload, { size: 18 }),
                                            React.createElement('input', { type: 'file', accept: '.json', className: 'hidden', onChange: importSongbook })
                                        ])
                                    ])
                                ]),
                                React.createElement('div', { className: "flex-1 flex gap-4 overflow-hidden" }, [
                                    React.createElement('div', { className: "w-1/3 bg-gray-800 rounded-lg border border-gray-700 overflow-y-auto" }, React.createElement('ul', { className: "divide-y divide-gray-700" }, filteredSongs.map(song => React.createElement('li', { key: song.id, onClick: () => { setSelectedSong(song); setIsEditingSong(false); }, className: `p-3 cursor-pointer hover:bg-gray-700 transition-colors ${selectedSong?.id === song.id ? 'bg-blue-900/30 border-l-4 border-blue-500' : ''}` }, [
                                        React.createElement('div', { className: "font-medium truncate" }, song.title),
                                        song.artist && React.createElement('div', { className: "text-xs text-gray-500 truncate" }, song.artist)
                                    ])))),
                                    React.createElement('div', { className: "flex-1 bg-gray-800 rounded-lg border border-gray-700 p-4 flex flex-col overflow-hidden" }, isEditingSong ? React.createElement('div', { className: "flex flex-col h-full space-y-4" }, [
                                        React.createElement('div', { className: "flex space-x-2" }, [
                                            React.createElement('input', { type: "text", placeholder: "Title", value: newSongTitle, onChange: (e) => setNewSongTitle(e.target.value), className: "flex-1 bg-gray-900 border-gray-600 rounded-lg text-white outline-none p-2" }),
                                            React.createElement('button', { onClick: fetchLyrics, disabled: isFetchingLyrics, className: "px-3 bg-gray-700 hover:bg-blue-600 rounded-lg text-white" }, React.createElement(Globe, { size: 18 }))
                                        ]),
                                        React.createElement('input', { type: "text", placeholder: "Artist", value: newSongArtist, onChange: (e) => setNewSongArtist(e.target.value), className: "w-full bg-gray-900 border-gray-600 rounded-lg text-white outline-none p-2" }),
                                        React.createElement('textarea', { placeholder: "Lyrics...", value: newSongLyrics, onChange: (e) => setNewSongLyrics(e.target.value), className: "flex-1 bg-gray-900 border-gray-600 rounded-lg text-white font-mono text-sm p-4 outline-none" }),
                                        React.createElement('div', { className: "flex justify-end space-x-2" }, [ React.createElement('button', { onClick: () => setIsEditingSong(false), className: "px-4 py-2 text-gray-400" }, "Cancel"), React.createElement('button', { onClick: handleSaveSong, className: "flex items-center px-4 py-2 bg-blue-600 rounded-lg text-white" }, [React.createElement(Save, { size: 16, className: "mr-2" }), "Save"]) ])
                                    ]) : selectedSong ? React.createElement('div', { className: "flex flex-col h-full" }, [
                                        React.createElement('div', { className: "flex justify-between items-start mb-4" }, [ 
                                            React.createElement('h2', { className: "text-xl font-bold" }, selectedSong.title),
                                            React.createElement('div', { className: "flex space-x-2" }, [ 
                                                React.createElement('button', { onClick: () => addToProgram({ type: 'song', text: '', fullText: selectedSong.lyrics, title: selectedSong.title, desc: "Song: " + selectedSong.title, originalId: selectedSong.id }), className: "p-2 text-gray-400 hover:text-white bg-gray-800 rounded-lg" }, React.createElement(List, { size: 16 })),
                                                React.createElement('button', { onClick: () => { setIsEditingSong(true); setNewSongTitle(selectedSong.title); setNewSongArtist(selectedSong.artist || ''); setNewSongLyrics(selectedSong.lyrics); }, className: "p-2 text-gray-400 hover:text-white" }, React.createElement(Edit3, { size: 16 })), 
                                                React.createElement('button', { onClick: () => { if(confirm('Delete?')) { deleteSongFromDB(selectedSong.id); setSelectedSong(null); refreshLocalSongs(); } }, className: "p-2 text-gray-400 hover:text-red-500" }, React.createElement(Trash2, { size: 16 })) 
                                            ]) 
                                        ]),
                                        React.createElement('div', { className: "flex-1 overflow-y-auto space-y-2" }, selectedSong.lyrics.split('\n\n').map((stanza, idx) => React.createElement('div', { key: idx, className: "group p-3 rounded-lg border border-gray-700 hover:border-gray-500 bg-gray-900/50 cursor-pointer", onClick: () => projectContent({ type: 'song', text: stanza, title: selectedSong.title }) }, [ React.createElement('div', { className: "text-sm whitespace-pre-wrap" }, stanza) ])))
                                    ]) : React.createElement('div', { className: "flex-1 flex items-center justify-center text-gray-500" }, "Select a song"))
                                ])
                            ]),

                            // CUSTOM TAB
                            React.createElement('div', { className: activeTab === 'custom' ? "max-w-4xl mx-auto w-full space-y-4 animate-in fade-in duration-200 h-full flex flex-col" : "hidden-tab" }, [
                                // Top Toolbar
                                React.createElement('div', { className: "bg-gray-800 p-2 rounded-lg border border-gray-700 flex items-center space-x-4 overflow-x-auto" }, [
                                    React.createElement('div', { className: "flex items-center space-x-2 border-r border-gray-600 pr-4" }, [
                                        React.createElement('button', { onClick: addCustomText, className: "flex items-center px-3 py-1 bg-green-700 hover:bg-green-600 text-white rounded text-sm" }, [ React.createElement(TypeIcon, { size: 14, className: "mr-1" }), "Text" ]),
                                        React.createElement('label', { className: "flex items-center px-3 py-1 bg-purple-700 hover:bg-purple-600 text-white rounded text-sm cursor-pointer" }, [ 
                                            React.createElement(ImageIcon, { size: 14, className: "mr-1" }), "Img",
                                            React.createElement('input', { type: 'file', accept: 'image/*', className: 'hidden', onChange: addCustomImage })
                                        ]),
                                        React.createElement('button', { onClick: deleteSelectedElement, className: "p-1.5 text-gray-400 hover:text-red-400 hover:bg-red-900/20 rounded" }, React.createElement(Trash2, { size: 16 }))
                                    ]),
                                    
                                    // Layering
                                    React.createElement('div', { className: "flex items-center space-x-1 border-r border-gray-600 pr-4" }, [
                                        React.createElement('span', { className: "text-xs text-gray-500 mr-1" }, "Layer"),
                                        React.createElement('button', { onClick: () => changeLayer('front'), title: "Bring to Front", className: "p-1.5 hover:bg-gray-700 rounded text-gray-400" }, React.createElement(ArrowUpFromLine, { size: 16 })),
                                        React.createElement('button', { onClick: () => changeLayer('up'), title: "Forward", className: "p-1.5 hover:bg-gray-700 rounded text-gray-400" }, React.createElement(Plus, { size: 16 })),
                                        React.createElement('button', { onClick: () => changeLayer('down'), title: "Backward", className: "p-1.5 hover:bg-gray-700 rounded text-gray-400" }, React.createElement(MinusCircle, { size: 16 })),
                                        React.createElement('button', { onClick: () => changeLayer('back'), title: "Send to Back", className: "p-1.5 hover:bg-gray-700 rounded text-gray-400" }, React.createElement(ArrowDownFromLine, { size: 16 })),
                                    ]),

                                    // Image Controls
                                    selectedElement.type === 'image' && React.createElement('div', { className: "flex items-center space-x-1 border-r border-gray-600 pr-4" }, [
                                        React.createElement('button', { onClick: openCropModal, className: "flex items-center px-3 py-1 bg-blue-700 hover:bg-blue-600 text-white rounded text-sm" }, [ React.createElement(Crop, { size: 14, className: "mr-1" }), "Crop" ])
                                    ]),

                                    // Text Controls
                                    selectedElement.type === 'text' && React.createElement(React.Fragment, {}, [
                                        React.createElement('div', { className: "flex items-center space-x-1 border-r border-gray-600 pr-4" }, [
                                            React.createElement('button', { onClick: () => updateSelectedStyle('align', 'left'), className: `p-2 rounded ${selectedElement.styles.align === 'left' ? 'bg-blue-600 text-white' : 'text-gray-400 hover:bg-gray-700'}` }, React.createElement(AlignLeft, { size: 18 })),
                                            React.createElement('button', { onClick: () => updateSelectedStyle('align', 'center'), className: `p-2 rounded ${selectedElement.styles.align === 'center' ? 'bg-blue-600 text-white' : 'text-gray-400 hover:bg-gray-700'}` }, React.createElement(AlignCenter, { size: 18 })),
                                            React.createElement('button', { onClick: () => updateSelectedStyle('align', 'right'), className: `p-2 rounded ${selectedElement.styles.align === 'right' ? 'bg-blue-600 text-white' : 'text-gray-400 hover:bg-gray-700'}` }, React.createElement(AlignRight, { size: 18 })),
                                        ]),
                                        React.createElement('div', { className: "flex items-center space-x-2 border-r border-gray-600 pr-4" }, [
                                            React.createElement('select', { value: selectedElement.styles.font, onChange: (e) => updateSelectedStyle('font', e.target.value), className: "bg-gray-900 border border-gray-700 text-white text-sm rounded p-1 w-24" }, 
                                                FONT_OPTIONS.map(f => React.createElement('option', { key: f.id, value: f.id }, f.name))
                                            ),
                                            React.createElement('input', { type: "number", min: "10", max: "200", value: selectedElement.styles.fontSize || fontSize, onChange: (e) => updateSelectedStyle('fontSize', e.target.value), className: "w-14 bg-gray-900 border border-gray-700 text-white text-sm rounded p-1" }),
                                        ]),
                                        React.createElement('div', { className: "flex items-center space-x-2 border-r border-gray-600 pr-4" }, [
                                            React.createElement('button', { onClick: () => updateSelectedStyle('bold', !selectedElement.styles.bold), className: `p-1.5 rounded ${selectedElement.styles.bold ? 'bg-blue-600 text-white' : 'text-gray-400 hover:bg-gray-700'}` }, React.createElement(Bold, { size: 16 })),
                                            React.createElement('button', { onClick: () => updateSelectedStyle('italic', !selectedElement.styles.italic), className: `p-1.5 rounded ${selectedElement.styles.italic ? 'bg-blue-600 text-white' : 'text-gray-400 hover:bg-gray-700'}` }, React.createElement(Italic, { size: 16 })),
                                        ]),
                                        React.createElement('div', { className: "flex items-center space-x-2" }, [
                                            React.createElement('div', { className: "flex items-center space-x-1" }, [
                                                React.createElement('span', { className: "text-xs text-gray-500" }, "Color"),
                                                React.createElement('input', { type: "color", value: selectedElement.styles.color, onChange: (e) => updateSelectedStyle('color', e.target.value), className: "w-6 h-6 rounded cursor-pointer bg-transparent" })
                                            ]),
                                            React.createElement('div', { className: "flex items-center space-x-1" }, [
                                                React.createElement('label', { className: "flex items-center cursor-pointer" }, [
                                                     React.createElement('input', { type: "checkbox", checked: selectedElement.styles.outline === 'none', onChange: (e) => updateSelectedStyle('outline', e.target.checked ? 'none' : '#000000'), className: "mr-1" }),
                                                     React.createElement('span', { className: "text-xs text-gray-500" }, "No Outline")
                                                ]),
                                                selectedElement.styles.outline !== 'none' && React.createElement('input', { type: "color", value: selectedElement.styles.outline, onChange: (e) => updateSelectedStyle('outline', e.target.value), className: "w-6 h-6 rounded cursor-pointer bg-transparent" })
                                            ])
                                        ])
                                    ])
                                ]),

                                // Editor Stage
                                React.createElement('div', { className: "flex-1 bg-black rounded-lg border border-gray-700 relative overflow-hidden flex items-center justify-center select-none" }, [
                                    React.createElement('div', { 
                                        ref: stageRef,
                                        className: "relative bg-gray-900 w-full aspect-video border border-gray-800 shadow-2xl overflow-hidden",
                                        style: { backgroundImage: backgroundImage ? `url("${backgroundImage}")` : 'none', backgroundSize: 'cover', backgroundPosition: 'center' }
                                    }, [
                                        !backgroundImage && React.createElement('div', { className: "absolute inset-0 flex items-center justify-center pointer-events-none opacity-20" }, React.createElement('span', { className: "text-6xl font-bold text-gray-700" }, "16:9 PREVIEW")),
                                        // Render Elements
                                        customElements.map(el => {
                                            const isSelected = el.id === selectedElementId;
                                            
                                            if (el.type === 'image') {
                                                return React.createElement('div', {
                                                    key: el.id,
                                                    className: `editor-element ${isSelected ? 'selected' : ''}`,
                                                    style: { left: `${el.x}%`, top: `${el.y}%`, width: `${el.w}%`, height: `${el.h}%`, zIndex: el.zIndex || 1 },
                                                    onMouseDown: (e) => handleStageMouseDown(e, el.id, 'move')
                                                }, [
                                                    React.createElement('img', { src: el.src, className: "w-full h-full object-contain pointer-events-none" }),
                                                    React.createElement('div', { className: "resize-handle", onMouseDown: (e) => handleStageMouseDown(e, el.id, 'resize') })
                                                ]);
                                            }

                                            // Render Text
                                            const s = el.styles;
                                            const shadow = getShadow(s.outline);
                                            const font = getFontFamily(s.font);
                                            return React.createElement('div', {
                                                key: el.id,
                                                className: `editor-element ${isSelected ? 'selected' : ''}`,
                                                style: {
                                                    left: `${el.x}%`, top: `${el.y}%`, width: `${el.w}%`, height: el.h ? `${el.h}%` : 'auto',
                                                    color: s.color, textAlign: s.align, fontFamily: font, fontWeight: s.bold ? 'bold' : 'normal', fontStyle: s.italic ? 'italic' : 'normal',
                                                    fontSize: `${(s.fontSize || fontSize) * 0.5}px`, // Scale down for preview
                                                    textShadow: shadow, whiteSpace: 'pre-wrap', wordWrap: 'break-word', zIndex: el.zIndex || 1
                                                },
                                                onMouseDown: (e) => handleStageMouseDown(e, el.id, 'move')
                                            }, [
                                                el.text,
                                                React.createElement('div', { className: "resize-handle", onMouseDown: (e) => handleStageMouseDown(e, el.id, 'resize') })
                                            ]);
                                        })
                                    ])
                                ]),

                                // Text Input for Selected Element
                                selectedElement.type === 'text' && React.createElement('div', { className: "space-y-2" }, [
                                    React.createElement('div', { className: "flex justify-between items-center" }, [
                                        React.createElement('span', { className: "text-xs text-gray-500 font-medium" }, "EDIT SELECTED TEXT"),
                                        React.createElement('span', { className: "text-xs text-gray-600" }, "Use Enter for new lines")
                                    ]),
                                    React.createElement('textarea', { 
                                        value: selectedElement.text, 
                                        onChange: (e) => updateSelectedElement({ text: e.target.value }), 
                                        placeholder: "Type text here...", 
                                        className: "w-full h-24 bg-gray-800 border border-gray-700 rounded-lg text-white p-4 outline-none resize-none font-sans" 
                                    })
                                ]),

                                // Actions
                                React.createElement('div', { className: "flex justify-end space-x-3 pt-2 border-t border-gray-800" }, [
                                    programEditMode !== false ? 
                                    React.createElement(React.Fragment, null, [
                                         React.createElement('span', { className: "flex items-center text-yellow-500 mr-auto text-sm font-bold animate-pulse" }, "EDITING PROGRAM SLIDE"),
                                         React.createElement('button', { onClick: () => { setProgramEditMode(false); setActiveTab('program'); }, className: "px-4 py-3 bg-gray-700 text-white rounded-lg" }, "Cancel"),
                                         React.createElement('button', { onClick: saveProgramCustomEdit, className: "flex items-center px-6 py-3 bg-blue-600 text-white rounded-lg hover:bg-blue-500" }, [React.createElement(Save, { size: 18, className: "mr-2" }), "Update Program Item"])
                                    ]) :
                                    React.createElement('button', { onClick: () => addToProgram({ type: 'custom', elements: customElements, desc: "Custom Slide (" + customElements.length + " items)" }), className: "flex items-center px-6 py-3 bg-gray-700 text-white rounded-lg hover:bg-gray-600" }, [React.createElement(Plus, { size: 18, className: "mr-2" }), "Add to Program"]),
                                    
                                    React.createElement('button', { onClick: () => projectContent({ type: 'custom', elements: customElements }), className: "flex items-center px-6 py-3 bg-green-600 text-white rounded-lg hover:bg-green-500" }, [React.createElement(Monitor, { size: 18, className: "mr-2" }), "Project Slide"])
                                ])
                            ]),

                            // SETTINGS TAB
                            React.createElement('div', { className: activeTab === 'settings' ? "max-w-4xl mx-auto w-full space-y-8 animate-in fade-in duration-200" : "hidden-tab" }, [
                                React.createElement('div', { className: "space-y-4" }, [
                                    React.createElement('h2', { className: "text-xl font-bold flex items-center" }, [ React.createElement(HardDrive, { className: "mr-2" }), "Local Theme Manager" ]),
                                    React.createElement('div', { className: "bg-gray-800 p-6 rounded-lg border border-gray-700" }, [
                                        
                                        // Upload Controls
                                        React.createElement('div', { className: "mb-8 p-4 bg-gray-900/50 rounded-lg border border-gray-700" }, [
                                            React.createElement('h3', { className: "text-sm font-semibold text-gray-400 uppercase mb-3" }, "Add New Theme (Saved to Computer)"),
                                            React.createElement('div', { className: "grid grid-cols-1 md:grid-cols-2 gap-4" }, [
                                                React.createElement('div', {}, [
                                                    React.createElement('label', { className: "block text-xs font-medium text-gray-500 mb-1" }, "Target Folder"),
                                                    !isCreatingFolder ? React.createElement('div', { className: "flex space-x-2" }, [
                                                        React.createElement('select', { value: themeCategory, onChange: (e) => setThemeCategory(e.target.value), className: "flex-1 bg-gray-800 border border-gray-600 rounded-lg p-2 text-white outline-none text-sm" }, 
                                                            availableFolders.map(f => React.createElement('option', { key: f, value: f }, f))
                                                        ),
                                                        React.createElement('button', { onClick: () => setIsCreatingFolder(true), className: "px-3 py-2 bg-gray-700 hover:bg-gray-600 rounded-lg text-white text-xs whitespace-nowrap", title: "Create New Folder" }, [ React.createElement(Plus, { size: 14, className: "inline mr-1" }), "New Folder" ])
                                                    ]) : React.createElement('div', { className: "flex space-x-2" }, [
                                                        React.createElement('input', { type: "text", placeholder: "Folder Name...", value: newFolderName, onChange: (e) => setNewFolderName(e.target.value), className: "flex-1 bg-gray-800 border border-blue-500 rounded-lg p-2 text-white outline-none text-sm focus:ring-1 focus:ring-blue-500" }),
                                                        React.createElement('button', { onClick: () => setIsCreatingFolder(false), className: "px-3 py-2 bg-gray-700 hover:bg-gray-600 rounded-lg text-white text-xs" }, "Cancel")
                                                    ])
                                                ]),
                                                React.createElement('div', {}, [
                                                    React.createElement('label', { className: "block text-xs font-medium text-gray-500 mb-1" }, "Select Image"),
                                                    React.createElement('input', { type: "file", accept: "image/png, image/jpeg, image/gif", onChange: handleLocalThemeUpload, disabled: uploadingTheme, className: "block w-full text-sm text-gray-400 file:mr-4 file:py-2 file:px-4 file:rounded-lg file:border-0 file:text-xs file:font-semibold file:bg-blue-600 file:text-white hover:file:bg-blue-700 cursor-pointer" })
                                                ])
                                            ]),
                                            uploadingTheme && React.createElement('div', { className: "mt-3 text-blue-400 text-xs flex items-center" }, [ React.createElement(Loader2, { size: 12, className: "animate-spin mr-2" }), "Processing image..." ])
                                        ]),

                                        // Folders Display
                                        Object.keys(localThemes).length === 0 ? React.createElement('div', { className: "text-center text-gray-500 py-8" }, "No themes found. Upload one above.") :
                                        React.createElement('div', { className: "space-y-6" }, Object.entries(localThemes).sort().map(([cat, themes]) => 
                                            React.createElement('div', { key: cat, className: "bg-gray-900/30 rounded-xl p-4 border border-gray-800" }, [
                                                React.createElement('div', { className: "flex items-center mb-3 border-b border-gray-800 pb-2" }, [
                                                    React.createElement(FolderInput, { size: 16, className: "text-blue-500 mr-2" }),
                                                    React.createElement('h3', { className: "text-sm font-bold text-white uppercase tracking-wide" }, cat),
                                                    React.createElement('span', { className: "ml-2 text-xs text-gray-600 bg-gray-800 px-2 py-0.5 rounded-full" }, themes.length)
                                                ]),
                                                React.createElement('div', { className: "grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 gap-3" }, themes.map(t => 
                                                    React.createElement('div', { key: t.id, className: `relative group rounded-lg overflow-hidden border-2 aspect-video bg-black cursor-pointer transition-all ${backgroundImage === t.url ? 'border-green-500 ring-2 ring-green-500/50' : 'border-gray-800 hover:border-blue-500'}` }, [
                                                        React.createElement('img', { src: t.url, className: "w-full h-full object-cover", onClick: () => setBackgroundImage(t.url) }),
                                                        React.createElement('div', { className: "absolute inset-x-0 bottom-0 bg-gradient-to-t from-black/90 to-transparent p-2 pt-6 opacity-0 group-hover:opacity-100 transition-opacity flex justify-between items-end" }, [
                                                            React.createElement('span', { className: "text-[10px] text-gray-300 truncate max-w-[70%]" }, t.name),
                                                            React.createElement('button', { onClick: (e) => { e.stopPropagation(); deleteTheme(t.id); }, className: "text-red-400 hover:text-red-200 bg-black/50 p-1 rounded hover:bg-red-900/50" }, React.createElement(Trash2, { size: 12 }))
                                                        ])
                                                    ])
                                                ))
                                            ])
                                        ))
                                    ])
                                ]),

                                React.createElement('div', { className: "h-px bg-gray-800" }),

                                React.createElement('div', { className: "space-y-4" }, [
                                    React.createElement('h2', { className: "text-xl font-bold flex items-center" }, [ React.createElement(FolderInput, { className: "mr-2" }), "Imports" ]),
                                    importStatus && React.createElement('div', { className: "p-3 bg-blue-900/30 border border-blue-800 text-blue-200 rounded-lg text-sm animate-pulse" }, importStatus),
                                    React.createElement('div', { className: "grid grid-cols-1 md:grid-cols-2 gap-4" }, [
                                        React.createElement('label', { className: "p-4 bg-gray-800 rounded-lg border border-gray-700 hover:bg-gray-700 cursor-pointer flex flex-col items-center justify-center text-center space-y-2" }, [
                                            React.createElement(Music, { size: 32, className: "text-yellow-500" }),
                                            React.createElement('span', { className: "font-semibold" }, "Batch Import Songs (Folder)"),
                                            React.createElement('input', { type: "file", webkitdirectory: "true", directory: "true", multiple: true, className: "hidden", onChange: (e) => handleFolderImport(e, 'Imported') })
                                        ]),
                                        React.createElement('label', { className: "p-4 bg-gray-800 rounded-lg border border-gray-700 hover:bg-gray-700 cursor-pointer flex flex-col items-center justify-center text-center space-y-2" }, [
                                            React.createElement(Cloud, { size: 32, className: "text-blue-500" }),
                                            React.createElement('span', { className: "font-semibold" }, "Upload XML Bible to Cloud"),
                                            React.createElement('span', { className: "text-xs text-gray-500" }, "Available to all users"),
                                            React.createElement('input', { type: "file", accept: ".xml", className: "hidden", onChange: handleBibleImportToCloud })
                                        ]),
                                    ]),
                                ])
                            ])
                        ]),

                        React.createElement('div', { className: "w-80 bg-black border-l border-gray-800 flex flex-col shrink-0" }, [
                            React.createElement('div', { className: "p-3 border-b border-gray-800 bg-gray-900" }, 
                                React.createElement('h3', { className: "text-xs font-bold text-gray-400 uppercase tracking-widest flex items-center" }, [
                                    React.createElement('div', { className: `w-2 h-2 rounded-full mr-2 ${liveContent ? 'bg-red-500 animate-pulse' : 'bg-gray-600'}` }),
                                    "Live Preview"
                                ])
                            ),
                            React.createElement('div', { className: "flex-1 p-4 flex items-center justify-center overflow-hidden relative" }, 
                                React.createElement('div', {
                                    className: "aspect-video w-full bg-white text-black rounded shadow-lg overflow-hidden relative flex flex-col items-center justify-center text-center select-none",
                                    style: { 
                                        backgroundImage: backgroundImage ? `url("${backgroundImage}")` : 'none',
                                        backgroundSize: 'cover',
                                        backgroundPosition: 'center',
                                        backgroundColor: theme === 'blue' ? '#1e3a8a' : theme === 'black' ? '#000' : '#fff', 
                                        color: backgroundImage ? 'white' : (theme === 'white' ? '#000' : '#fff')
                                    }
                                }, liveContent ? [
                                    backgroundImage && React.createElement('div', { className: "absolute inset-0 bg-black/40" }),
                                    // Live Preview Custom Render
                                    (liveContent.type === 'custom' || liveContent.type === 'program_custom')
                                    ? (liveContent.elements ?
                                        [...liveContent.elements].sort((a,b)=>(a.zIndex||0)-(b.zIndex||0)).map(el => {
                                            if(el.type === 'image') {
                                                return React.createElement('img', {
                                                    key: el.id, src: el.src,
                                                    style: { position: 'absolute', left: `${el.x}%`, top: `${el.y}%`, width: `${el.w}%`, height: `${el.h}%`, zIndex: el.zIndex||1, objectFit: 'contain' }
                                                });
                                            }
                                            const s = el.styles;
                                            const shadow = getShadow(s.outline);
                                            const font = getFontFamily(s.font);
                                            return React.createElement('div', {
                                                key: el.id,
                                                style: {
                                                    position: 'absolute',
                                                    left: `${el.x}%`, top: `${el.y}%`, width: `${el.w}%`, height: el.h ? `${el.h}%` : 'auto',
                                                    color: s.color, textAlign: s.align, fontFamily: font, fontWeight: s.bold?'bold':'normal', fontStyle: s.italic?'italic':'normal',
                                                    fontSize: 'clamp(8px, 1.5vw, 24px)', // Scale down for preview
                                                    whiteSpace: 'pre-wrap', textShadow: shadow, zIndex: el.zIndex||1
                                                }
                                            }, el.text)
                                        })
                                        : null
                                    )
                                    : [
                                        React.createElement('div', { style: { fontSize: 'clamp(8px, 2vw, 14px)', whiteSpace: 'pre-wrap', lineHeight: '1.2', zIndex: 10, padding: '1rem' }, className: "font-bold relative" }, liveContent.text),
                                        (liveContent.type === 'bible' || liveContent.type === 'program_bible') && React.createElement('div', { className: "mt-2 text-[8px] opacity-75 border-t border-current pt-1 relative z-10" }, liveContent.reference)
                                    ]
                                ] : React.createElement('div', { className: "text-gray-500 text-xs" }, "OFF AIR (Black)"))
                            ),
                            React.createElement('div', { className: "p-4 bg-gray-900 border-t border-gray-800" }, [
                                React.createElement('button', { onClick: () => setLiveContent(null), className: "w-full p-3 bg-red-900/30 hover:bg-red-900/50 border border-red-800 rounded text-xs text-center text-red-400 font-bold flex items-center justify-center" }, [React.createElement(Power, { size: 14, className: "mr-2" }), "Blackout (ESC)"])
                            ])
                        ])
                    ])
                ])
            ]);
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(React.createElement(App));
    </script>
</body>
</html>
